!function(){function t(e,n,i){function r(s,c){if(!n[s]){if(!e[s]){var a="function"==typeof require&&require;if(!c&&a)return a(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){return r(e[s][1][t]||t)},l,l.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}return t}()({1:[function(t,e,n){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(t){return"function"==typeof t}function o(t){return"number"==typeof t}function s(t){return"object"==typeof t&&null!==t}function c(t){return void 0===t}e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if(!o(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,n,i,o,a,u;if(this._events||(this._events={}),"error"===t&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var l=new Error('Uncaught, unspecified "error" event. ('+e+")");throw l.context=e,l}if(n=this._events[t],c(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(s(n))for(o=Array.prototype.slice.call(arguments,1),u=n.slice(),i=u.length,a=0;a<i;a++)u[a].apply(this,o);return!0},i.prototype.addListener=function(t,e){var n;if(!r(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,r(e.listener)?e.listener:e),this._events[t]?s(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,s(this._events[t])&&!this._events[t].warned&&(n=c(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[t].length>n&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(t,e){function n(){this.removeListener(t,n),i||(i=!0,e.apply(this,arguments))}if(!r(e))throw TypeError("listener must be a function");var i=!1;return n.listener=e,this.on(t,n),this},i.prototype.removeListener=function(t,e){var n,i,o,c;if(!r(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(n=this._events[t],o=n.length,i=-1,n===e||r(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(s(n)){for(c=o;c-- >0;)if(n[c]===e||n[c].listener&&n[c].listener===e){i=c;break}if(i<0)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[t],r(n))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){return this._events&&this._events[t]?r(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(r(e))return 1;if(e)return e.length}return 0},i.listenerCount=function(t,e){return t.listenerCount(e)}},{}],2:[function(t,e,n){var i=e.exports=function(t,e){if(e||(e=16),void 0===t&&(t=128),t<=0)return"0";for(var n=Math.log(Math.pow(2,t))/Math.log(e),r=2;n===1/0;r*=2)n=Math.log(Math.pow(2,t/r))/Math.log(e)*r;for(var o=n-Math.floor(n),s="",r=0;r<Math.floor(n);r++){var c=Math.floor(Math.random()*e).toString(e);s=c+s}if(o){var a=Math.pow(e,o),c=Math.floor(Math.random()*a).toString(e);s=c+s}var u=parseInt(s,e);return u!==1/0&&u>=Math.pow(2,t)?i(t,e):s};i.rack=function(t,e,n){var r=function(r){var s=0;do{if(s++>10){if(!n)throw new Error("too many ID collisions, use more bits");t+=n}var c=i(t,e)}while(Object.hasOwnProperty.call(o,c));return o[c]=r,c},o=r.hats={};return r.get=function(t){return r.hats[t]},r.set=function(t,e){return r.hats[t]=e,r},r.bits=t||128,r.base=e||16,r}},{}],3:[function(t,e,n){function i(t,e,n,i){var r=function(t,n,i,r){e(i,t,n,"left"),e(r,n,t,"right")},o=t.transformX=function(t,e){n(t),n(e);for(var s=[],c=0;c<e.length;c++){for(var a=e[c],u=[],l=0;l<t.length;){var h=[];if(r(t[l],a,u,h),l++,1!==h.length){if(0===h.length){for(var p=l;p<t.length;p++)i(u,t[p]);a=null;break}for(var f=o(t.slice(l),h),d=0;d<f[0].length;d++)i(u,f[0][d]);for(var _=0;_<f[1].length;_++)i(s,f[1][_]);a=null;break}a=h[0]}null!=a&&i(s,a),t=u}return[t,s]};t.transform=function(t,n,i){if("left"!==i&&"right"!==i)throw new Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],i):"left"===i?o(t,n)[0]:o(n,t)[1]}}e.exports=i},{}],4:[function(t,e,n){e.exports={type:t("./json0")}},{"./json0":5}],5:[function(t,e,n){function i(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function r(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}var o=function(t){return"[object Array]"==Object.prototype.toString.call(t)},s=function(t){return!!t&&t.constructor===Object},c=function(t){return JSON.parse(JSON.stringify(t))},a={name:"json0",uri:"http://sharejs.org/types/JSONv0"},u={};a.registerSubtype=function(t){u[t.name]=t},a.create=function(t){return void 0===t?null:c(t)},a.invertComponent=function(t){var e={p:t.p};return t.t&&u[t.t]&&(e.t=t.t,e.o=u[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},a.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;i<e.length;i++)n.push(a.invertComponent(e[i]));return n},a.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!o(t[e].p))throw new Error("Missing path")},a.checkList=function(t){if(!o(t))throw new Error("Referenced element not a list")},a.checkObj=function(t){if(!s(t))throw new Error("Referenced element not an object (it was "+JSON.stringify(t)+")")},a.apply=function(t,e){a.checkValidOp(e),e=c(e);for(var n={data:t},r=0;r<e.length;r++){var o=e[r];null==o.si&&null==o.sd||i(o);for(var s=null,l=n,h="data",p=0;p<o.p.length;p++){var f=o.p[p];if(s=l,h,l=l[h],h=f,null==s)throw new Error("Path invalid")}if(o.t&&void 0!==o.o&&u[o.t])l[h]=u[o.t].apply(l[h],o.o);else if(void 0!==o.na){if("number"!=typeof l[h])throw new Error("Referenced element not a number");l[h]+=o.na}else if(void 0!==o.li&&void 0!==o.ld)a.checkList(l),l[h]=o.li;else if(void 0!==o.li)a.checkList(l),l.splice(h,0,o.li);else if(void 0!==o.ld)a.checkList(l),l.splice(h,1);else if(void 0!==o.lm){if(a.checkList(l),o.lm!=h){var d=l[h];l.splice(h,1),l.splice(o.lm,0,d)}}else if(void 0!==o.oi)a.checkObj(l),l[h]=o.oi;else{if(void 0===o.od)throw new Error("invalid / missing instruction in op");a.checkObj(l),delete l[h]}}return n.data},a.shatter=function(t){for(var e=[],n=0;n<t.length;n++)e.push([t[n]]);return e},a.incrementalApply=function(t,e,n){for(var i=0;i<e.length;i++){var r=[e[i]];t=a.apply(t,r),n(r,t)}return t};var l=a.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i]&&(!n||i!==t.length-1))return!1;return!0};a.append=function(t,e){if(e=c(e),0===t.length)return void t.push(e);var n=t[t.length-1];if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(i(e),i(n)),l(e.p,n.p))if(e.t&&n.t&&e.t===n.t&&u[e.t]){if(n.o=u[e.t].compose(n.o,e.o),null!=e.si||null!=e.sd){for(var o=e.p,s=0;s<n.o.length-1;s++)e.o=[n.o.pop()],e.p=o.slice(),r(e),t.push(e);r(n)}}else null!=n.na&&null!=e.na?t[t.length-1]={p:n.p,na:n.na+e.na}:void 0!==n.li&&void 0===e.li&&e.ld===n.li?void 0!==n.ld?delete n.li:t.pop():void 0!==n.od&&void 0===n.oi&&void 0!==e.oi&&void 0===e.od?n.oi=e.oi:void 0!==n.oi&&void 0!==e.od?void 0!==e.oi?n.oi=e.oi:void 0!==n.od?delete n.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else null==e.si&&null==e.sd||null==n.si&&null==n.sd||(r(e),r(n)),t.push(e)},a.compose=function(t,e){a.checkValidOp(t),a.checkValidOp(e);for(var n=c(t),i=0;i<e.length;i++)a.append(n,e[i]);return n},a.normalize=function(t){var e=[];t=o(t)?t:[t];for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=[]),a.append(e,i)}return e},a.commonLengthForOps=function(t,e){var n=t.p.length,i=e.p.length;if((null!=t.na||t.t)&&n++,(null!=e.na||e.t)&&i++,0===n)return-1;if(0===i)return null;n--,i--;for(var r=0;r<n;r++){var o=t.p[r];if(r>=i||o!==e.p[r])return null}return n},a.canOpAffectPath=function(t,e){return null!=a.commonLengthForOps({p:e},t)},a.transformComponent=function(t,e,n,s){e=c(e);var l=a.commonLengthForOps(n,e),h=a.commonLengthForOps(e,n),p=e.p.length,f=n.p.length;if((null!=e.na||e.t)&&p++,(null!=n.na||n.t)&&f++,null!=h&&f>p&&e.p[h]==n.p[h])if(void 0!==e.ld){var d=c(n);d.p=d.p.slice(p),e.ld=a.apply(c(e.ld),[d])}else if(void 0!==e.od){var d=c(n);d.p=d.p.slice(p),e.od=a.apply(c(e.od),[d])}if(null!=l){var _=p==f,d=n;if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(i(e),d=c(n),i(d)),d.t&&u[d.t]){if(e.t&&e.t===d.t){var v=u[e.t].transform(e.o,d.o,s);if(null!=e.si||null!=e.sd)for(var y=e.p,g=0;g<v.length;g++)e.o=[v[g]],e.p=y.slice(),r(e),a.append(t,e);else(!o(v)||v.length>0)&&(e.o=v,a.append(t,e));return t}}else if(void 0!==n.na);else if(void 0!==n.li&&void 0!==n.ld){if(n.p[l]===e.p[l]){if(!_)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==s)return t;e.ld=c(n.li)}}}else if(void 0!==n.li)void 0!==e.li&&void 0===e.ld&&_&&e.p[l]===n.p[l]?"right"===s&&e.p[l]++:n.p[l]<=e.p[l]&&e.p[l]++,void 0!==e.lm&&_&&n.p[l]<=e.lm&&e.lm++;else if(void 0!==n.ld){if(void 0!==e.lm&&_){if(n.p[l]===e.p[l])return t;var y=n.p[l],m=e.p[l],E=e.lm;(y<E||y===E&&m<E)&&e.lm--}if(n.p[l]<e.p[l])e.p[l]--;else if(n.p[l]===e.p[l]){if(f<p)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==n.lm)if(void 0!==e.lm&&p===f){var m=e.p[l],E=e.lm,O=n.p[l],R=n.lm;if(O!==R)if(m===O){if("left"!==s)return t;e.p[l]=R,m===E&&(e.lm=R)}else m>O&&e.p[l]--,m>R?e.p[l]++:m===R&&O>R&&(e.p[l]++,m===E&&e.lm++),E>O?e.lm--:E===O&&E>m&&e.lm--,E>R?e.lm++:E===R&&(R>O&&E>m||R<O&&E<m?"right"===s&&e.lm++:E>m?e.lm++:E===O&&e.lm--)}else if(void 0!==e.li&&void 0===e.ld&&_){var m=n.p[l],E=n.lm;y=e.p[l],y>m&&e.p[l]--,y>E&&e.p[l]++}else{var m=n.p[l],E=n.lm;y=e.p[l],y===m?e.p[l]=E:(y>m&&e.p[l]--,y>E?e.p[l]++:y===E&&m>E&&e.p[l]++)}else if(void 0!==n.oi&&void 0!==n.od){if(e.p[l]===n.p[l]){if(void 0===e.oi||!_)return t;if("right"===s)return t;e.od=n.oi}}else if(void 0!==n.oi){if(void 0!==e.oi&&e.p[l]===n.p[l]){if("left"!==s)return t;a.append(t,{p:e.p,od:n.oi})}}else if(void 0!==n.od&&e.p[l]==n.p[l]){if(!_)return t;if(void 0===e.oi)return t;delete e.od}}return a.append(t,e),t},t("./bootstrapTransform")(a,a.transformComponent,a.checkValidOp,a.append);var h=t("./text0");a.registerSubtype(h),e.exports=a},{"./bootstrapTransform":3,"./text0":6}],6:[function(t,e,n){var i=e.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw new Error("Initial data must be a string");return t||""}},r=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},o=function(t){if("number"!=typeof t.p)throw new Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw new Error("component needs an i or d field");if(t.p<0)throw new Error("position cannot be negative")},s=function(t){for(var e=0;e<t.length;e++)o(t[e])};i.apply=function(t,e){var n;s(e);for(var i=0;i<e.length;i++){var o=e[i];if(null!=o.i)t=r(t,o.p,o.i);else{if(n=t.slice(o.p,o.p+o.d.length),o.d!==n)throw new Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");t=t.slice(0,o.p)+t.slice(o.p+o.d.length)}}return t};var c=i._append=function(t,e){if(""!==e.i&&""!==e.d)if(0===t.length)t.push(e);else{var n=t[t.length-1];null!=n.i&&null!=e.i&&n.p<=e.p&&e.p<=n.p+n.i.length?t[t.length-1]={i:r(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=n.p&&n.p<=e.p+e.d.length?t[t.length-1]={d:r(e.d,n.p-e.p,n.d),p:e.p}:t.push(e)}};i.compose=function(t,e){s(t),s(e);for(var n=t.slice(),i=0;i<e.length;i++)c(n,e[i]);return n},i.normalize=function(t){var e=[];null==t.i&&null==t.p||(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=0),c(e,i)}return e};var a=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length};i.transformCursor=function(t,e,n){for(var i="right"===n,r=0;r<e.length;r++)t=a(t,e[r],i);return t};var u=i._tc=function(t,e,n,i){if(o(e),o(n),null!=e.i)c(t,{i:e.i,p:a(e.p,n,"right"===i)});else if(null!=n.i){var r=e.d;e.p<n.p&&(c(t,{d:r.slice(0,n.p-e.p),p:e.p}),r=r.slice(n.p-e.p)),""!==r&&c(t,{d:r,p:e.p+n.i.length})}else if(e.p>=n.p+n.d.length)c(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)c(t,e);else{var s={d:"",p:e.p};e.p<n.p&&(s.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(s.d+=e.d.slice(n.p+n.d.length-e.p));var u=Math.max(e.p,n.p),l=Math.min(e.p+e.d.length,n.p+n.d.length),h=e.d.slice(u-e.p,l-e.p),p=n.d.slice(u-n.p,l-n.p);if(h!==p)throw new Error("Delete ops delete different text in the same region of the document");""!==s.d&&(s.p=a(s.p,n),c(t,s))}return t},l=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}};i.invert=function(t){t=t.slice().reverse();for(var e=0;e<t.length;e++)t[e]=l(t[e]);return t},t("./bootstrapTransform")(i,u,s,c)},{"./bootstrapTransform":3}],7:[function(t,e,n){function i(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(t){if(h===setTimeout)return setTimeout(t,0);if((h===i||!h)&&setTimeout)return h=setTimeout,setTimeout(t,0);try{return h(t,0)}catch(e){try{return h.call(null,t,0)}catch(e){return h.call(this,t,0)}}}function s(t){if(p===clearTimeout)return clearTimeout(t);if((p===r||!p)&&clearTimeout)return p=clearTimeout,clearTimeout(t);try{return p(t)}catch(e){try{return p.call(null,t)}catch(e){return p.call(this,t)}}}function c(){v&&d&&(v=!1,d.length?_=d.concat(_):y=-1,_.length&&a())}function a(){if(!v){var t=o(c);v=!0;for(var e=_.length;e;){for(d=_,_=[];++y<e;)d&&d[y].run();y=-1,e=_.length}d=null,v=!1,s(t)}}function u(t,e){this.fun=t,this.array=e}function l(){}var h,p,f=e.exports={};!function(){try{h="function"==typeof setTimeout?setTimeout:i}catch(t){h=i}try{p="function"==typeof clearTimeout?clearTimeout:r}catch(t){p=r}}();var d,_=[],v=!1,y=-1;f.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];_.push(new u(t,e)),1!==_.length||v||o(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=l,f.addListener=l,f.once=l,f.off=l,f.removeListener=l,f.removeAllListeners=l,f.emit=l,f.prependListener=l,f.prependOnceListener=l,f.listeners=function(t){return[]},f.binding=function(t){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(t){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},{}],8:[function(t,e,n){(function(n){function i(t){return 0===t.readyState||1===t.readyState?"connecting":"disconnected"}function r(t){d.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._snapshotRequests={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.state=i(t),this.bindToSocket(t)}function o(t,e){var n=new Error(t.message);return n.code=t.code,e&&(n.data=e),n}function s(t){return t.hasPending()}function c(t){return t.hasWritePending()}var a=t("./doc"),u=t("./query"),l=t("./presence/presence"),h=t("./presence/doc-presence"),p=t("./snapshot-request/snapshot-version-request"),f=t("./snapshot-request/snapshot-timestamp-request"),d=t("../emitter"),_=t("../error"),v=t("../types"),y=t("../util"),g=t("../logger"),m=_.CODES;e.exports=r,d.mixin(r),r.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=t;var e=i(t);this._setState(e),this.canSend=!1;var r=this;t.onmessage=function(t){try{var e="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){return void g.warn("Failed to parse message",t)}r.debug&&g.info("RECV",JSON.stringify(e));var i={data:e};if(r.emit("receive",i),i.data)try{r.handleMessage(i.data)}catch(t){n.nextTick(function(){r.emit("error",t)})}},1===t.readyState&&r._initializeHandshake(),t.onopen=function(){r._setState("connecting"),r._initializeHandshake()},t.onerror=function(t){r.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?r._setState("closed",t):"stopped"===t||"Stopped by server"===t?r._setState("stopped",t):r._setState("disconnected",t)}},r.prototype.handleMessage=function(t){var e=null;switch(t.error&&(e=o(t.error,t),delete t.error),t.a){case"init":return this._handleLegacyInit(t);case"hs":return this._handleHandshake(e,t);case"qf":var n=this.queries[t.id];return void(n&&n._handleFetch(e,t.data,t.extra));case"qs":var n=this.queries[t.id];return void(n&&n._handleSubscribe(e,t.data,t.extra));case"qu":return;case"q":var n=this.queries[t.id];if(!n)return;return e?n._handleError(e):(t.diff&&n._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&n._handleExtra(t.extra)));case"bf":return this._handleBulkMessage(e,t,"_handleFetch");case"bs":return this._handleBulkMessage(e,t,"_handleSubscribe");case"bu":return this._handleBulkMessage(e,t,"_handleUnsubscribe");case"nf":case"nt":return this._handleSnapshotFetch(e,t);case"f":var i=this.getExisting(t.c,t.d);return void(i&&i._handleFetch(e,t.data));case"s":var i=this.getExisting(t.c,t.d);return void(i&&i._handleSubscribe(e,t.data));case"u":var i=this.getExisting(t.c,t.d);return void(i&&i._handleUnsubscribe(e));case"op":var i=this.getExisting(t.c,t.d);return void(i&&i._handleOp(e,t));case"p":return this._handlePresence(e,t);case"ps":return this._handlePresenceSubscribe(e,t);case"pu":return this._handlePresenceUnsubscribe(e,t);case"pr":return this._handlePresenceRequest(e,t);default:g.warn("Ignoring unrecognized message",t)}},r.prototype._handleBulkMessage=function(t,e,n){if(e.data)for(var i in e.data){var r=e.data[i],s=this.getExisting(e.c,i);s&&(t?s[n](t):r.error?s[n](o(r.error)):s[n](null,r))}else if(Array.isArray(e.b))for(var c=0;c<e.b.length;c++){var i=e.b[c],s=this.getExisting(e.c,i);s&&s[n](t)}else if(e.b)for(var i in e.b){var s=this.getExisting(e.c,i);s&&s[n](t)}else g.error("Invalid bulk message",e)},r.prototype._reset=function(){this.agent=null},r.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state){var n=new _(m.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+t);return this.emit("error",n)}this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk();for(var i in this.queries){this.queries[i]._onConnectionStateChanged()}for(var r in this.collections){var o=this.collections[r];for(var i in o)o[i]._onConnectionStateChanged()}for(var s in this._presences)this._presences[s]._onConnectionStateChanged();for(var i in this._snapshotRequests){this._snapshotRequests[i]._onConnectionStateChanged()}this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},r.prototype.startBulk=function(){this.bulk||(this.bulk={})},r.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},r.prototype._sendBulk=function(t,e,n){if(n){var i,r=[],o={},s=0;for(var c in n){var a=n[c];null==a?r.push(c):(o[c]=a,i=c,s++)}if(1===r.length){var c=r[0];this.send({a:t,c:e,d:c})}else r.length&&this.send({a:"b"+t,c:e,b:r});if(1===s){var u=o[i];this.send({a:t,c:e,d:i,v:u})}else s&&this.send({a:"b"+t,c:e,b:o})}},r.prototype._sendAction=function(t,e,n){if(this._addDoc(e),this.bulk){var i=this.bulk[e.collection]||(this.bulk[e.collection]={}),r=i[t]||(i[t]={}),o=r.hasOwnProperty(e.id);return r[e.id]=n,o}var s={a:t,c:e.collection,d:e.id,v:n};this.send(s)},r.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},r.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},r.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},r.prototype.sendOp=function(t,e){this._addDoc(t);var n={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq};e.op&&(n.op=e.op),e.create&&(n.create=e.create),e.del&&(n.del=e.del),this.send(n)},r.prototype.send=function(t){this.debug&&g.info("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},r.prototype.close=function(){this.socket.close()},r.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},r.prototype.get=function(t,e){var n=this.collections[t]||(this.collections[t]={}),i=n[e];return i||(i=n[e]=new a(this,t,e),this.emit("doc",i)),i},r.prototype._destroyDoc=function(t){y.digAndRemove(this.collections,t.collection,t.id)},r.prototype._addDoc=function(t){var e=this.collections[t.collection];e||(e=this.collections[t.collection]={}),e[t.id]!==t&&(e[t.id]=t)},r.prototype._createQuery=function(t,e,n,i,r){var o=this.nextQueryId++,s=new u(t,this,o,e,n,i,r);return this.queries[o]=s,s.send(),s},r.prototype._destroyQuery=function(t){delete this.queries[t.id]},r.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("qf",t,e,n,i)},r.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("qs",t,e,n,i)},r.prototype.hasPending=function(){return!!(this._firstDoc(s)||this._firstQuery(s)||this._firstSnapshotRequest())},r.prototype.hasWritePending=function(){return!!this._firstDoc(c)},r.prototype.whenNothingPending=function(t){var e=this._firstDoc(s);if(e)return void e.once("nothing pending",this._nothingPendingRetry(t));var i=this._firstQuery(s);if(i)return void i.once("ready",this._nothingPendingRetry(t));var r=this._firstSnapshotRequest();if(r)return void r.once("ready",this._nothingPendingRetry(t));n.nextTick(t)},r.prototype._nothingPendingRetry=function(t){var e=this;return function(){n.nextTick(function(){e.whenNothingPending(t)})}},r.prototype._firstDoc=function(t){for(var e in this.collections){var n=this.collections[e];for(var i in n){var r=n[i];if(t(r))return r}}},r.prototype._firstQuery=function(t){for(var e in this.queries){var n=this.queries[e];if(t(n))return n}},r.prototype._firstSnapshotRequest=function(){for(var t in this._snapshotRequests)return this._snapshotRequests[t]},r.prototype.fetchSnapshot=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,o=new p(this,r,t,e,n,i);this._snapshotRequests[o.requestId]=o,o.send()},r.prototype.fetchSnapshotByTimestamp=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,o=new f(this,r,t,e,n,i);this._snapshotRequests[o.requestId]=o,o.send()},r.prototype._handleSnapshotFetch=function(t,e){var n=this._snapshotRequests[e.id];n&&(delete this._snapshotRequests[e.id],n._handleResponse(t,e))},r.prototype._handleLegacyInit=function(t){t.protocolMinor||this._initialize(t)},r.prototype._initializeHandshake=function(){this.send({a:"hs",id:this.id})},r.prototype._handleHandshake=function(t,e){if(t)return this.emit("error",t);this._initialize(e)},r.prototype._initialize=function(t){return 1!==t.protocol?this.emit("error",new _(m.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+t.protocol)):v.map[t.type]!==v.defaultType?this.emit("error",new _(m.ERR_DEFAULT_TYPE_MISMATCH,t.type+" does not match the server default type")):"string"!=typeof t.id?this.emit("error",new _(m.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string")):(this.id=t.id,void this._setState("connected"))},r.prototype.getPresence=function(t){var e=this;return y.digOrCreate(this._presences,t,function(){return new l(e,t)})},r.prototype.getDocPresence=function(t,e){var n=h.channel(t,e),i=this;return y.digOrCreate(this._presences,n,function(){return new h(i,t,e)})},r.prototype._sendPresenceAction=function(t,e,n){this._addPresence(n);var i={a:t,ch:n.channel,seq:e};return this.send(i),i.seq},r.prototype._addPresence=function(t){y.digOrCreate(this._presences,t.channel,function(){return t})},r.prototype._handlePresenceSubscribe=function(t,e){var n=y.dig(this._presences,e.ch);n&&n._handleSubscribe(t,e.seq)},r.prototype._handlePresenceUnsubscribe=function(t,e){var n=y.dig(this._presences,e.ch);n&&n._handleUnsubscribe(t,e.seq)},r.prototype._handlePresence=function(t,e){var n=y.dig(this._presences,e.ch);n&&n._receiveUpdate(t,e)},r.prototype._handlePresenceRequest=function(t,e){var n=y.dig(this._presences,e.ch);n&&n._broadcastAllLocalPresence(t,e)}}).call(this,t("_process"))},{"../emitter":21,"../error":22,"../logger":23,"../types":27,"../util":28,"./doc":9,"./presence/doc-presence":11,"./presence/presence":14,"./query":17,"./snapshot-request/snapshot-timestamp-request":19,"./snapshot-request/snapshot-version-request":20,_process:7}],9:[function(t,e,n){(function(n){function i(t,e,n){a.EventEmitter.call(this),this.connection=t,this.collection=e,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function r(t,e,n){if(e){var i=t.pop();t.push(function(t){i&&i(t),n&&n(t)})}else t.push(n)}function o(t){delete t.op,delete t.create,delete t.del}function s(t,e){if(t.del)return o(e);if(e.del)return new l(f.ERR_DOC_WAS_DELETED,"Document was deleted");if(e.create)return new l(f.ERR_DOC_ALREADY_CREATED,"Document already created");if(e.op){if(t.create)return new l(f.ERR_DOC_ALREADY_CREATED,"Document already created");if(t.type.transformX){var n=t.type.transformX(t.op,e.op);t.op=n[0],e.op=n[1]}else{var i=t.type.transform(t.op,e.op,"left"),r=t.type.transform(e.op,t.op,"right");t.op=i,e.op=r}}}function c(t,e){for(var n=!1,i=0;i<t.length;i++){var r=t[i];r&&(r(e),n=!0)}return n}var a=t("../emitter"),u=t("../logger"),l=t("../error"),h=t("../types"),p=t("../util"),f=l.CODES;e.exports=i,a.mixin(i),i.prototype.destroy=function(t){var e=this;e.whenNothingPending(function(){e.wantSubscribe?e.unsubscribe(function(n){if(n)return t?t(n):e.emit("error",n);e.connection._destroyDoc(e),e.emit("destroy"),t&&t()}):(e.connection._destroyDoc(e),e.emit("destroy"),t&&t())})},i.prototype._setType=function(t){if("string"==typeof t&&(t=h.map[t]),t)this.type=t;else{if(null!==t){var e=new l(f.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+t);return this.emit("error",e)}this.type=t,this.data=void 0}},i.prototype.ingestSnapshot=function(t,e){if(!t)return e&&e();if("number"!=typeof t.v){var n=new l(f.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return e?e(n):this.emit("error",n)}if(this.type||this.hasWritePending()){if(null==this.version){if(this.hasWritePending())return e&&this.once("no write pending",e);var n=new l(f.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return e?e(n):this.emit("error",n)}return t.v>this.version?this.fetch(e):e&&e()}if(this.version>t.v)return e&&e();this.version=t.v;var i=void 0===t.type?h.defaultType:t.type;this._setType(i),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),e&&e()},i.prototype.whenNothingPending=function(t){var e=this;n.nextTick(function(){if(e.hasPending())return void e.once("nothing pending",t);t()})},i.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},i.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},i.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},i.prototype._emitResponseError=function(t,e){return t&&t.code===f.ERR_SNAPSHOT_READ_SILENT_REJECTION?(this.wantSubscribe=!1,e&&e(),void this._emitNothingPending()):e?(e(t),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",t))},i.prototype._handleFetch=function(t,e){var n=this.inflightFetch.shift();if(t)return this._emitResponseError(t,n);this.ingestSnapshot(e,n),this._emitNothingPending()},i.prototype._handleSubscribe=function(t,e){var n=this.inflightSubscribe.shift();if(t)return this._emitResponseError(t,n);this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(e,n),this._emitNothingPending()},i.prototype._handleUnsubscribe=function(t){var e=this.inflightUnsubscribe.shift();if(t)return this._emitResponseError(t,e);e&&e(),this._emitNothingPending()},i.prototype._handleOp=function(t,e){if(t)return this.inflightOp?(t.code===f.ERR_OP_SUBMIT_REJECTED&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&e.src===this.inflightOp.src&&e.seq===this.inflightOp.seq)return void this._opAcknowledged(e);if(null==this.version||e.v>this.version)return void this.fetch();if(!(e.v<this.version)){if(this.inflightOp){var n=s(this.inflightOp,e);if(n)return this._hardRollback(n)}for(var i=0;i<this.pendingOps.length;i++){var n=s(this.pendingOps[i],e);if(n)return this._hardRollback(n)}this.version++;try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}}},i.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)this.flush(),this._resubscribe();else if(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length){var t=this.inflightUnsubscribe;this.inflightUnsubscribe=[],c(t)}},i.prototype._resubscribe=function(){var t=this.pendingFetch;if(this.pendingFetch=[],this.wantSubscribe)return t.length?void this.subscribe(function(e){c(t,e)}):void this.subscribe();t.length&&this.fetch(function(e){c(t,e)})},i.prototype.fetch=function(t){if(this.connection.canSend){var e=this.connection.sendFetch(this);return void r(this.inflightFetch,e,t)}this.pendingFetch.push(t)},i.prototype.subscribe=function(t){if(this.wantSubscribe=!0,this.connection.canSend){var e=this.connection.sendSubscribe(this);return void r(this.inflightSubscribe,e,t)}this.pendingFetch.push(t)},i.prototype.unsubscribe=function(t){if(this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend){var e=this.connection.sendUnsubscribe(this);return void r(this.inflightUnsubscribe,e,t)}t&&n.nextTick(t)},i.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},i.prototype._otApply=function(t,e){if(t.op){
if(!this.type)throw new l(f.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(!e&&this.type===h.defaultType&&t.op.length>1){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<t.op.length;i++){for(var r=t.op[i],o={op:[r]},c=n;c<this.applyStack.length;c++){var a=s(this.applyStack[c],o);if(a)return this._hardRollback(a)}this.emit("before op",o.op,e,t.src),this.data=this.type.apply(this.data,o.op),this.emit("op",o.op,e,t.src)}return void this._popApplyStack(n)}return this.emit("before op",t.op,e,t.src),this.data=this.type.apply(this.data,t.op),void this.emit("op",t.op,e,t.src)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",e);if(t.del){var u=this.data;return this._setType(null),void this.emit("del",u,e)}},i.prototype._sendOp=function(){if(this.connection.canSend){var t=this.connection.id;this.inflightOp||(this.inflightOp=this.pendingOps.shift());var e=this.inflightOp;if(!e){var n=new l(f.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp");return this.emit("error",n)}if(e.sentAt=Date.now(),e.retries=null==e.retries?0:e.retries+1,null==e.seq){if(this.connection.seq>=p.MAX_SAFE_INTEGER)return this.emit("error",new l(f.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));e.seq=this.connection.seq++}this.connection.sendOp(this,e),null==e.src&&(e.src=t)}},i.prototype._submit=function(t,e,i){if(e||(e=!0),t.op){if(!this.type){var r=new l(f.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return i?i(r):this.emit("error",r)}this.type.normalize&&(t.op=this.type.normalize(t.op))}try{this._pushOp(t,i),this._otApply(t,e)}catch(t){return this._hardRollback(t)}var o=this;n.nextTick(function(){o.flush()})},i.prototype._pushOp=function(t,e){if(this.applyStack)this.applyStack.push(t);else{var n=this._tryCompose(t);if(n)return void n.callbacks.push(e)}t.type=this.type,t.callbacks=[e],this.pendingOps.push(t)},i.prototype._popApplyStack=function(t){if(t>0)return void(this.applyStack.length=t);var e=this.applyStack[0];if(this.applyStack=null,e){var n=this.pendingOps.indexOf(e);if(-1!==n)for(var i=this.pendingOps.splice(n),n=0;n<i.length;n++){var e=i[n],r=this._tryCompose(e);r?r.callbacks=r.callbacks.concat(e.callbacks):this.pendingOps.push(e)}}},i.prototype._tryCompose=function(t){if(!this.preventCompose){var e=this.pendingOps[this.pendingOps.length-1];if(e&&!e.sentAt)return e.create&&t.op?(e.create.data=this.type.apply(e.create.data,t.op),e):e.op&&t.op&&this.type.compose?(e.op=this.type.compose(e.op,t.op),e):void 0}},i.prototype.submitOp=function(t,e,n){"function"==typeof e&&(n=e,e=null);var i={op:t},r=e&&e.source;this._submit(i,r,n)},i.prototype.create=function(t,e,n,i){if("function"==typeof e?(i=e,n=null,e=null):"function"==typeof n&&(i=n,n=null),e||(e=h.defaultType.uri),this.type){var r=new l(f.ERR_DOC_ALREADY_CREATED,"Document already exists");return i?i(r):this.emit("error",r)}var o={create:{type:e,data:t}},s=n&&n.source;this._submit(o,s,i)},i.prototype.del=function(t,e){if("function"==typeof t&&(e=t,t=null),!this.type){var n=new l(f.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");return e?e(n):this.emit("error",n)}var i={del:!0},r=t&&t.source;this._submit(i,r,e)},i.prototype.pause=function(){this.paused=!0},i.prototype.resume=function(){this.paused=!1,this.flush()},i.prototype._opAcknowledged=function(t){if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return u.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},i.prototype._rollback=function(t){var e=this.inflightOp;if(e.op&&e.type.invert){e.op=e.type.invert(e.op);for(var n=0;n<this.pendingOps.length;n++){var i=s(this.pendingOps[n],e);if(i)return this._hardRollback(i)}try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}return void this._clearInflightOp(t)}this._hardRollback(t)},i.prototype._hardRollback=function(t){var e=[];this.inflightOp&&e.push(this.inflightOp),e=e.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var i=!!e.length,r=0;r<e.length;r++)i=c(e[r].callbacks,t)&&i;if(t&&!i)return n.emit("error",t)})},i.prototype._clearInflightOp=function(t){var e=this.inflightOp;this.inflightOp=null;var n=c(e.callbacks,t);if(this.flush(),this._emitNothingPending(),t&&!n)return this.emit("error",t)}}).call(this,t("_process"))},{"../emitter":21,"../error":22,"../logger":23,"../types":27,"../util":28,_process:7}],10:[function(t,e,n){n.Connection=t("./connection"),n.Doc=t("./doc"),n.Error=t("../error"),n.Query=t("./query"),n.types=t("../types"),n.logger=t("../logger")},{"../error":22,"../logger":23,"../types":27,"./connection":8,"./doc":9,"./query":17}],11:[function(t,e,n){function i(t,e,n){var o=i.channel(e,n);r.call(this,t,o),this.collection=e,this.id=n}var r=t("./presence"),o=t("./local-doc-presence"),s=t("./remote-doc-presence");e.exports=i,i.prototype=Object.create(r.prototype),i.channel=function(t,e){return t+"."+e},i.prototype._createLocalPresence=function(t){return new o(this,t)},i.prototype._createRemotePresence=function(t){return new s(this,t)}},{"./local-doc-presence":12,"./presence":14,"./remote-doc-presence":15}],12:[function(t,e,n){function i(t,e){r.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._isSending=!1,this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}var r=t("./local-presence"),o=t("../../error"),s=o.CODES;e.exports=i,i.prototype=Object.create(r.prototype),i.prototype.submit=function(t,e){if(!this._doc.type){var n={code:s.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,e)}r.prototype.submit.call(this,t,e)},i.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createOrDelHandler),this._doc.removeListener("del",this._createOrDelHandler),this._doc.removeListener("load",this._loadHandler),this._doc.removeListener("destroy",this._destroyHandler),r.prototype.destroy.call(this,t)},i.prototype._sendPending=function(){if(!this._isSending){this._isSending=!0;var t=this;this._doc.whenNothingPending(function(){t._isSending=!1,t.connection.canSend&&(t._pendingMessages.forEach(function(e){e.t=t._doc.type.uri,e.v=t._doc.version,t.connection.send(e)}),t._pendingMessages=[])})}},i.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createOrDelHandler),this._doc.on("del",this._createOrDelHandler),this._doc.on("load",this._loadHandler),this._doc.on("destroy",this._destroyHandler)},i.prototype._transformAgainstOp=function(t,e){var n=this;this._pendingMessages.forEach(function(i){try{i.p=n._doc.type.transformPresence(i.p,t,e)}catch(t){var r=n._getCallback(i.pv);n._callbackOrEmit(t,r)}});try{this.value=this._doc.type.transformPresence(this.value,t,e)}catch(t){this.emit("error",t)}},i.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(t){t.p=null}),this.value=null},i.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[]},i.prototype._message=function(){var t=r.prototype._message.call(this);return t.c=this.collection,t.d=this.id,t.v=null,t.t=null,t}},{"../../error":22,"./local-presence":13}],13:[function(t,e,n){(function(n){function i(t,e){if(r.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("LocalPresence presenceId must be a string");this.presence=t,this.presenceId=e,this.connection=t.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}var r=t("../../emitter");e.exports=i,r.mixin(i),i.prototype.submit=function(t,e){this.value=t,this.send(e)},i.prototype.send=function(t){var e=this._message();this._pendingMessages.push(e),this._callbacksByPresenceVersion[e.pv]=t,this._sendPending()},i.prototype.destroy=function(t){var e=this;this.submit(null,function(n){if(n)return e._callbackOrEmit(n,t);delete e.presence.localPresences[e.presenceId],t&&t()})},i.prototype._sendPending=function(){if(this.connection.canSend){var t=this;this._pendingMessages.forEach(function(e){t.connection.send(e)}),this._pendingMessages=[]}},i.prototype._ack=function(t,e){var n=this._getCallback(e);this._callbackOrEmit(t,n)},i.prototype._message=function(){return{a:"p",ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}},i.prototype._getCallback=function(t){var e=this._callbacksByPresenceVersion[t];return delete this._callbacksByPresenceVersion[t],e},i.prototype._callbackOrEmit=function(t,e){if(e)return n.nextTick(e,t);t&&this.emit("error",t)}}).call(this,t("_process"))},{"../../emitter":21,_process:7}],14:[function(t,e,n){(function(n){function i(t,e){if(r.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("Presence channel must be provided");this.connection=t,this.channel=e,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this.seq=1,this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={}}var r=t("../../emitter"),o=t("./local-presence"),s=t("./remote-presence"),c=t("../../util"),a=t("async"),u=t("hat");e.exports=i,r.mixin(i),i.prototype.subscribe=function(t){this._sendSubscriptionAction(!0,t)},i.prototype.unsubscribe=function(t){this._sendSubscriptionAction(!1,t)},i.prototype.create=function(t){t=t||u();var e=this._createLocalPresence(t);return this.localPresences[t]=e,e},i.prototype.destroy=function(t){var e=this;this.unsubscribe(function(n){if(n)return e._callbackOrEmit(n,t);var i=Object.keys(e.localPresences),r=Object.keys(e._remotePresenceInstances);a.parallel([function(t){a.each(i,function(t,n){e.localPresences[t].destroy(n)},t)},function(t){a.each(r,function(t,n){e._remotePresenceInstances[t].destroy(n)},t)}],function(n){delete e.connection._presences[e.channel],e._callbackOrEmit(n,t)})})},i.prototype._sendSubscriptionAction=function(t,e){this.wantSubscribe=!!t;var n=this.wantSubscribe?"ps":"pu",i=this.seq++;this._subscriptionCallbacksBySeq[i]=e,this.connection.canSend&&this.connection._sendPresenceAction(n,i,this)},i.prototype._handleSubscribe=function(t,e){this.wantSubscribe&&(this.subscribed=!0);var n=this._subscriptionCallback(e);this._callbackOrEmit(t,n)},i.prototype._handleUnsubscribe=function(t,e){this.subscribed=!1;var n=this._subscriptionCallback(e);this._callbackOrEmit(t,n)},i.prototype._receiveUpdate=function(t,e){var n=c.dig(this.localPresences,e.id);if(n)return n._ack(t,e.pv);if(t)return this.emit("error",t);var i=this;c.digOrCreate(this._remotePresenceInstances,e.id,function(){return i._createRemotePresence(e.id)}).receiveUpdate(e)},i.prototype._updateRemotePresence=function(t){this.remotePresences[t.presenceId]=t.value,null===t.value&&this._removeRemotePresence(t.presenceId),this.emit("receive",t.presenceId,t.value)},i.prototype._broadcastAllLocalPresence=function(t){if(t)return this.emit("error",t);for(var e in this.localPresences){var n=this.localPresences[e];null!==n.value&&n.send()}},i.prototype._removeRemotePresence=function(t){this._remotePresenceInstances[t].destroy(),delete this._remotePresenceInstances[t],delete this.remotePresences[t]},i.prototype._onConnectionStateChanged=function(){if(this.connection.canSend){this._resubscribe();for(var t in this.localPresences)this.localPresences[t]._sendPending()}},i.prototype._resubscribe=function(){var t=[];for(var e in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(e);t.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(null,t);var i=this;this.subscribe(function(e){i._callEachOrEmit(e,t)})},i.prototype._subscriptionCallback=function(t){var e=this._subscriptionCallbacksBySeq[t];return delete this._subscriptionCallbacksBySeq[t],e},i.prototype._callbackOrEmit=function(t,e){if(e)return n.nextTick(e,t);t&&this.emit("error",t)},i.prototype._createLocalPresence=function(t){return new o(this,t)},i.prototype._createRemotePresence=function(t){return new s(this,t)},i.prototype._callEachOrEmit=function(t,e){if(e&&e.length)return e.forEach(function(e){n.nextTick(e,t)});t&&this.emit("error",t)}}).call(this,t("_process"))},{"../../emitter":21,"../../util":28,"./local-presence":13,"./remote-presence":16,_process:7,async:29,hat:2}],15:[function(t,e,n){function i(t,e){r.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}var r=t("./remote-presence"),o=t("../../ot");e.exports=i,i.prototype=Object.create(r.prototype),i.prototype.receiveUpdate=function(t){this._pending&&t.pv<this._pending.pv||(this.src=t.src,this._pending=t,this._setPendingPresence())},i.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createDelHandler),this._doc.removeListener("del",this._createDelHandler),this._doc.removeListener("load",this._loadHandler),r.prototype.destroy.call(this,t)},i.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createDelHandler),this._doc.on("del",this._createDelHandler),this._doc.on("load",this._loadHandler)},i.prototype._setPendingPresence=function(){if(!this._pendingSetPending){this._pendingSetPending=!0;var t=this;this._doc.whenNothingPending(function(){if(t._pendingSetPending=!1,t._pending)return t._pending.pv<t.presenceVersion?t._pending=null:t._pending.v>t._doc.version?t._doc.fetch():void(t._catchUpStalePresence()&&(t.value=t._pending.p,t.presenceVersion=t._pending.pv,t._pending=null,t.presence._updateRemotePresence(t)))})}},i.prototype._handleOp=function(t,e,n){var i=n===this.src;this._transformAgainstOp(t,i),this._cacheOp(t,i),this._setPendingPresence()},r.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()},r.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)},i.prototype._transformAgainstOp=function(t,e){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,t,e)}catch(t){return this.presence.emit("error",t)}this.presence._updateRemotePresence(this)}},i.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var t=this._opCache[this._pending.v],e=t.op,n=t.isOwnOp;null===e?(this._pending.p=null,this._pending.v++):o.transformPresence(this._pending,e,n)}var i=this._pending.v>=this._doc.version;return i&&this._stopCachingOps(),i},i.prototype._startCachingOps=function(){this._opCache=[]},i.prototype._stopCachingOps=function(){this._opCache=null},i.prototype._cacheOp=function(t,e){this._opCache&&(t=t?{op:t}:null,this._opCache[this._doc.version-1]={op:t,isOwnOp:e})}},{"../../ot":25,"./remote-presence":16}],16:[function(t,e,n){(function(t){function n(t,e){this.presence=t,this.presenceId=e,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}e.exports=n,n.prototype.receiveUpdate=function(t){t.pv<this.presenceVersion||(this.value=t.p,this.presenceVersion=t.pv,this.presence._updateRemotePresence(this))},n.prototype.destroy=function(e){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],e&&t.nextTick(e)}}).call(this,t("_process"))},{_process:7}],17:[function(t,e,n){(function(n){function i(t,e,n,i,o,s,c){r.EventEmitter.call(this),this.action=t,this.connection=e,this.id=n,this.collection=i,this.query=o,this.results=null,s&&s.results&&(this.results=s.results,delete s.results),this.extra=void 0,this.options=s,this.callback=c,this.ready=!1,this.sent=!1}var r=t("../emitter");e.exports=i,r.mixin(i),i.prototype.hasPending=function(){return!this.ready},i.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],n=0;n<this.results.length;n++){var i=this.results[n];e.push([i.id,i.version])}t.r=e}this.connection.send(t),this.sent=!0}},i.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&n.nextTick(t)},i.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},i.prototype._handleFetch=function(t,e,n){this.connection._destroyQuery(this),this._handleResponse(t,e,n)},i.prototype._handleSubscribe=function(t,e,n){this._handleResponse(t,e,n)},i.prototype._handleResponse=function(t,e,n){var i=this.callback;if(this.callback=null,t)return this._finishResponse(t,i);if(!e)return this._finishResponse(null,i);var r=this,o=1,s=function(t){if(t)return r._finishResponse(t,i);--o||r._finishResponse(null,i)};if(Array.isArray(e))o+=e.length,this.results=this._ingestSnapshots(e,s),this.extra=n;else for(var c in e){o++;var a=e[c],u=this.connection.get(a.c||this.collection,c);u.ingestSnapshot(a,s)}s()},i.prototype._ingestSnapshots=function(t,e){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=this.connection.get(r.c||this.collection,r.d);o.ingestSnapshot(r,e),n.push(o)}return n},i.prototype._finishResponse=function(t,e){if(this.emit("ready"),this.ready=!0,t)return this.connection._destroyQuery(this),e?e(t):this.emit("error",t);e&&e(null,this.results,this.extra)},i.prototype._handleError=function(t){this.emit("error",t)},i.prototype._handleDiff=function(t){for(var e=0;e<t.length;e++){var n=t[e];"insert"===n.type&&(n.values=this._ingestSnapshots(n.values))}for(var e=0;e<t.length;e++){var n=t[e];switch(n.type){case"insert":var i=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(i)),this.emit("insert",i,n.index);break;case"remove":var r=n.howMany||1,o=this.results.splice(n.index,r);this.emit("remove",o,n.index);break;case"move":var r=n.howMany||1,s=this.results.splice(n.from,r);Array.prototype.splice.apply(this.results,[n.to,0].concat(s)),this.emit("move",s,n.from,n.to)}}this.emit("changed",this.results)},i.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)}}).call(this,t("_process"))},{"../emitter":21,_process:7}],18:[function(t,e,n){function i(t,e,n,i,r){if(o.EventEmitter.call(this),"function"!=typeof r)throw new Error("Callback is required for SnapshotRequest");this.requestId=e,this.connection=t,this.id=i,this.collection=n,this.callback=r,this.sent=!1}var r=t("../../snapshot"),o=t("../../emitter");e.exports=i,o.mixin(i),i.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},i.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},i.prototype._handleResponse=function(t,e){if(this.emit("ready"),t)return this.callback(t);var n=e.meta?e.meta:null,i=new r(this.id,e.v,e.type,e.data,n);this.callback(null,i)}},{"../../emitter":21,"../../snapshot":26}],19:[function(t,e,n){function i(t,e,n,i,s,c){if(r.call(this,t,e,n,i,c),!o.isValidTimestamp(s))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=s}var r=t("./snapshot-request"),o=t("../../util");e.exports=i,i.prototype=Object.create(r.prototype),i.prototype._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}}},{"../../util":28,"./snapshot-request":18}],20:[function(t,e,n){function i(t,e,n,i,s,c){if(r.call(this,t,e,n,i,c),!o.isValidVersion(s))throw new Error("Snapshot version must be a positive integer or null");this.version=s}var r=t("./snapshot-request"),o=t("../../util");e.exports=i,i.prototype=Object.create(r.prototype),i.prototype._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}}},{"../../util":28,"./snapshot-request":18}],21:[function(t,e,n){function i(t){for(var e in r.prototype)t.prototype[e]=r.prototype[e]}var r=t("events").EventEmitter;n.EventEmitter=r,n.mixin=i},{events:1}],22:[function(t,e,n){function i(t,e){this.code=t,this.message=e||"",Error.captureStackTrace?Error.captureStackTrace(this,i):this.stack=(new Error).stack}i.prototype=Object.create(Error.prototype),i.prototype.constructor=i,i.prototype.name="ShareDBError",i.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"},e.exports=i},{}],23:[function(t,e,n){var i=t("./logger"),r=new i;e.exports=r},{"./logger":24}],24:[function(t,e,n){function i(){var t={};r.forEach(function(e){t[e]=console[e].bind(console)}),this.setMethods(t)}var r=["info","warn","error"];e.exports=i,i.prototype.setMethods=function(t){t=t||{};var e=this;r.forEach(function(n){"function"==typeof t[n]&&(e[n]=t[n])})}},{}],25:[function(t,e,n){function i(t,e){if(!t.type)return new o(c.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(null==e)return new o(c.ERR_OT_OP_NOT_PROVIDED,"Missing op");var n=r[t.type];if(!n)return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=n.apply(t.data,e)}catch(t){return t}}var r=t("./types").map,o=t("./error"),s=t("./util"),c=o.CODES;n.checkOp=function(t){if(null==t||"object"!=typeof t)return new o(c.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(null!=t.create){if("object"!=typeof t.create)return new o(c.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var e=t.create.type;if("string"!=typeof e)return new o(c.ERR_OT_OP_BADLY_FORMED,"Missing create type");var n=r[e];if(null==n||"object"!=typeof n)return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(null!=t.del){if(!0!==t.del)return new o(c.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(null==t.op)return new o(c.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");return null!=t.src&&"string"!=typeof t.src?new o(c.ERR_OT_OP_BADLY_FORMED,"src must be a string"):null!=t.seq&&"number"!=typeof t.seq?new o(c.ERR_OT_OP_BADLY_FORMED,"seq must be a string"):null==t.src&&null!=t.seq||null!=t.src&&null==t.seq?new o(c.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together"):null!=t.m&&"object"!=typeof t.m?new o(c.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null"):void 0},n.normalizeType=function(t){return r[t]&&r[t].uri},n.apply=function(t,e){if("object"!=typeof t)return new o(c.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(null!=t.v&&null!=e.v&&t.v!==e.v)return new o(c.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(e.create){if(t.type)return new o(c.ERR_DOC_ALREADY_CREATED,"Document already exists");var n=e.create,s=r[n.type];if(!s)return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=s.create(n.data),t.type=s.uri,t.v++}catch(a){return a}}else if(e.del)t.data=void 0,t.type=null,t.v++;else if(e.op){var a=i(t,e.op);if(a)return a;t.v++}else t.v++},n.transform=function(t,e,n){if(null!=e.v&&e.v!==n.v)return new o(c.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(n.del){if(e.create||e.op)return new o(c.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(n.create&&(e.op||e.create||e.del)||n.op&&e.create)return new o(c.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if(n.op&&e.op){if(!t)return new o(c.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if("string"==typeof t&&!(t=r[t]))return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.op=t.transform(e.op,n.op,"left")}catch(t){return t}}}null!=e.v&&e.v++},n.applyOps=function(t,e){var n=null;if(t.type&&!(n=r[t.type]))return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");for(var i=0;i<e.length;i++){var s=e[i];if(t.v=s.v+1,s.create){if(!(n=r[s.create.type]))return new o(c.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");t.data=n.create(s.create.data),t.type=n.uri}else s.del?(t.data=void 0,n=null,t.type=null):t.data=n.apply(t.data,s.op)}},n.transformPresence=function(t,e,n){var i=this.checkOp(e);if(i)return i;var o=t.t;if("string"==typeof o&&(o=r[o]),!o)return{code:c.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!s.supportsPresence(o))return{code:c.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(e.create||e.del)return t.p=null,void t.v++;try{t.p=null===t.p?null:o.transformPresence(t.p,e.op,n)}catch(t){return{code:c.ERR_PRESENCE_TRANSFORM_FAILED,message:t.message||t}}t.v++}},{"./error":22,"./types":27,"./util":28}],26:[function(t,e,n){function i(t,e,n,i,r){this.id=t,this.v=e,this.type=n,this.data=i,this.m=r}e.exports=i},{}],27:[function(t,e,n){n.defaultType=t("ot-json0").type,n.map={},n.register=function(t){t.name&&(n.map[t.name]=t),t.uri&&(n.map[t.uri]=t)},n.register(n.defaultType)},{"ot-json0":4}],28:[function(t,e,n){function i(){}n.doNothing=i,n.hasKeys=function(t){for(var e in t)return!0;return!1},n.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},n.isValidVersion=function(t){return null===t||n.isInteger(t)&&t>=0},n.isValidTimestamp=function(t){return n.isValidVersion(t)},n.MAX_SAFE_INTEGER=9007199254740991,n.dig=function(){for(var t=arguments[0],e=1;e<arguments.length;e++){t=t[arguments[e]]||(e===arguments.length-1?void 0:{})}return t},n.digOrCreate=function(){for(var t=arguments[0],e=arguments[arguments.length-1],n=1;n<arguments.length-1;n++){var i=arguments[n];t=t[i]||(t[i]=n===arguments.length-2?e():{})}return t},n.digAndRemove=function(){for(var t=arguments[0],e=[t],i=1;i<arguments.length-1;i++){var r=arguments[i];if(!t.hasOwnProperty(r))break;t=t[r],e.push(t)}for(var i=e.length-1;i>=0;i--){var o=e[i],r=arguments[i+1],s=o[r];i!==e.length-1&&n.hasKeys(s)||delete o[r]}},n.supportsPresence=function(t){return t&&"function"==typeof t.transformPresence}},{}],29:[function(t,e,n){(function(t,i,r){!function(t,i){"object"==typeof n&&void 0!==e?i(n):"function"==typeof define&&define.amd?define(["exports"],i):i(t.async=t.async||{})}(this,function(n){"use strict";function o(t,e){e|=0;for(var n=Math.max(t.length-e,0),i=Array(n),r=0;r<n;r++)i[r]=t[e+r];return i}function s(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function c(t){setTimeout(t,0)}function a(t){return function(e){var n=o(arguments,1);t(function(){e.apply(null,n)})}}function u(t){return ce(function(e,n){var i;try{i=t.apply(this,e)}catch(t){return n(t)}s(i)&&"function"==typeof i.then?i.then(function(t){l(n,null,t)},function(t){l(n,t.message?t:new Error(t))}):n(null,i)})}function l(t,e,n){try{t(e,n)}catch(t){le(h,t)}}function h(t){throw t}function p(t){return he&&"AsyncFunction"===t[Symbol.toStringTag]}function f(t){return p(t)?u(t):t}function d(t){return function(e){var n=o(arguments,1),i=ce(function(n,i){var r=this;return t(e,function(t,e){f(t).apply(r,n.concat(e))},i)});return n.length?i.apply(this,n):i}}function _(t){var e=ye.call(t,me),n=t[me];try{t[me]=void 0;var i=!0}catch(t){}var r=ge.call(t);return i&&(e?t[me]=n:delete t[me]),r}function v(t){return Oe.call(t)}function y(t){return null==t?void 0===t?be:Re:Se&&Se in Object(t)?_(t):v(t)}function g(t){if(!s(t))return!1;var e=y(t);return e==De||e==Pe||e==Te||e==Ae}function m(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=Ne}function E(t){return null!=t&&m(t.length)&&!g(t)}function O(){}function R(t){return function(){if(null!==t){var e=t;t=null,e.apply(this,arguments)}}}function b(t,e){for(var n=-1,i=Array(t);++n<t;)i[n]=e(n);return i}function S(t){return null!=t&&"object"==typeof t}function T(t){return S(t)&&y(t)==Ce}function D(){return!1}function P(t,e){var n=typeof t;return!!(e=null==e?Ge:e)&&("number"==n||"symbol"!=n&&We.test(t))&&t>-1&&t%1==0&&t<e}function A(t){return S(t)&&m(t.length)&&!!ze[y(t)]}function N(t,e){var n=qe(t),i=!n&&je(t),r=!n&&!i&&Ye(t),o=!n&&!i&&!r&&tn(t),s=n||i||r||o,c=s?b(t.length,String):[],a=c.length;for(var u in t)!e&&!nn.call(t,u)||s&&("length"==u||r&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||P(u,a))||c.push(u);return c}function w(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||rn)}function I(t){if(!w(t))return on(t);var e=[];for(var n in Object(t))cn.call(t,n)&&"constructor"!=n&&e.push(n);return e}function k(t){return E(t)?N(t):I(t)}function C(t){var e=-1,n=t.length;return function(){return++e<n?{value:t[e],key:e}:null}}function L(t){var e=-1;return function(){var n=t.next();return n.done?null:(e++,{value:n.value,key:e})}}function x(t){var e=k(t),n=-1,i=e.length;return function(){var r=e[++n];return n<i?{value:t[r],key:r}:null}}function M(t){if(E(t))return C(t);var e=ke(t);return e?L(e):x(t)}function j(t){return function(){if(null===t)throw new Error("Callback was already called.");var e=t;t=null,e.apply(this,arguments)}}function q(t){return function(e,n,i){function r(t,e){if(a-=1,t)c=!0,i(t);else{if(e===we||c&&a<=0)return c=!0,i(null);u||o()}}function o(){for(u=!0;a<t&&!c;){var e=s();if(null===e)return c=!0,void(a<=0&&i(null));a+=1,n(e.value,e.key,j(r))}u=!1}if(i=R(i||O),t<=0||!e)return i(null);var s=M(e),c=!1,a=0,u=!1;o()}}function F(t,e,n,i){q(e)(t,f(n),i)}function U(t,e){return function(n,i,r){return t(n,e,i,r)}}function B(t,e,n){
function i(t,e){t?n(t):++o!==s&&e!==we||n(null)}n=R(n||O);var r=0,o=0,s=t.length;for(0===s&&n(null);r<s;r++)e(t[r],r,j(i))}function V(t){return function(e,n,i){return t(un,e,f(n),i)}}function H(t,e,n,i){i=i||O,e=e||[];var r=[],o=0,s=f(n);t(e,function(t,e,n){var i=o++;s(t,function(t,e){r[i]=e,n(t)})},function(t){i(t,r)})}function Y(t){return function(e,n,i,r){return t(q(n),e,f(i),r)}}function G(t,e){for(var n=-1,i=null==t?0:t.length;++n<i&&!1!==e(t[n],n,t););return t}function W(t,e){return t&&_n(t,e,k)}function z(t,e,n,i){for(var r=t.length,o=n+(i?1:-1);i?o--:++o<r;)if(e(t[o],o,t))return o;return-1}function Q(t){return t!==t}function J(t,e,n){for(var i=n-1,r=t.length;++i<r;)if(t[i]===e)return i;return-1}function X(t,e,n){return e===e?J(t,e,n):z(t,Q,n)}function Z(t,e){for(var n=-1,i=null==t?0:t.length,r=Array(i);++n<i;)r[n]=e(t[n],n,t);return r}function K(t){return"symbol"==typeof t||S(t)&&y(t)==yn}function $(t){if("string"==typeof t)return t;if(qe(t))return Z(t,$)+"";if(K(t))return En?En.call(t):"";var e=t+"";return"0"==e&&1/t==-gn?"-0":e}function tt(t,e,n){var i=-1,r=t.length;e<0&&(e=-e>r?0:r+e),n=n>r?r:n,n<0&&(n+=r),r=e>n?0:n-e>>>0,e>>>=0;for(var o=Array(r);++i<r;)o[i]=t[i+e];return o}function et(t,e,n){var i=t.length;return n=void 0===n?i:n,!e&&n>=i?t:tt(t,e,n)}function nt(t,e){for(var n=t.length;n--&&X(e,t[n],0)>-1;);return n}function it(t,e){for(var n=-1,i=t.length;++n<i&&X(e,t[n],0)>-1;);return n}function rt(t){return t.split("")}function ot(t){return On.test(t)}function st(t){return t.match(wn)||[]}function ct(t){return ot(t)?st(t):rt(t)}function at(t){return null==t?"":$(t)}function ut(t,e,n){if((t=at(t))&&(n||void 0===e))return t.replace(In,"");if(!t||!(e=$(e)))return t;var i=ct(t),r=ct(e);return et(i,it(i,r),nt(i,r)+1).join("")}function lt(t){return t=t.toString().replace(xn,""),t=t.match(kn)[2].replace(" ",""),t=t?t.split(Cn):[],t=t.map(function(t){return ut(t.replace(Ln,""))})}function ht(t,e){var n={};W(t,function(t,e){function i(e,n){var i=Z(r,function(t){return e[t]});i.push(n),f(t).apply(null,i)}var r,o=p(t),s=!o&&1===t.length||o&&0===t.length;if(qe(t))r=t.slice(0,-1),t=t[t.length-1],n[e]=r.concat(r.length>0?i:t);else if(s)n[e]=t;else{if(r=lt(t),0===t.length&&!o&&0===r.length)throw new Error("autoInject task functions require explicit parameters.");o||r.pop(),n[e]=r.concat(i)}}),vn(n,e)}function pt(){this.head=this.tail=null,this.length=0}function ft(t,e){t.length=1,t.head=t.tail=e}function dt(t,e,n){function i(t,e,n){if(null!=n&&"function"!=typeof n)throw new Error("task callback must be a function");if(l.started=!0,qe(t)||(t=[t]),0===t.length&&l.idle())return le(function(){l.drain()});for(var i=0,r=t.length;i<r;i++){var o={data:t[i],callback:n||O};e?l._tasks.unshift(o):l._tasks.push(o)}a||(a=!0,le(function(){a=!1,l.process()}))}function r(t){return function(e){s-=1;for(var n=0,i=t.length;n<i;n++){var r=t[n],o=X(c,r,0);0===o?c.shift():o>0&&c.splice(o,1),r.callback.apply(r,arguments),null!=e&&l.error(e,r.data)}s<=l.concurrency-l.buffer&&l.unsaturated(),l.idle()&&l.drain(),l.process()}}if(null==e)e=1;else if(0===e)throw new Error("Concurrency must not be zero");var o=f(t),s=0,c=[],a=!1,u=!1,l={_tasks:new pt,concurrency:e,payload:n,saturated:O,unsaturated:O,buffer:e/4,empty:O,drain:O,error:O,started:!1,paused:!1,push:function(t,e){i(t,!1,e)},kill:function(){l.drain=O,l._tasks.empty()},unshift:function(t,e){i(t,!0,e)},remove:function(t){l._tasks.remove(t)},process:function(){if(!u){for(u=!0;!l.paused&&s<l.concurrency&&l._tasks.length;){var t=[],e=[],n=l._tasks.length;l.payload&&(n=Math.min(n,l.payload));for(var i=0;i<n;i++){var a=l._tasks.shift();t.push(a),c.push(a),e.push(a.data)}s+=1,0===l._tasks.length&&l.empty(),s===l.concurrency&&l.saturated();var h=j(r(t));o(e,h)}u=!1}},length:function(){return l._tasks.length},running:function(){return s},workersList:function(){return c},idle:function(){return l._tasks.length+s===0},pause:function(){l.paused=!0},resume:function(){!1!==l.paused&&(l.paused=!1,le(l.process))}};return l}function _t(t,e){return dt(t,1,e)}function vt(t,e,n,i){i=R(i||O);var r=f(n);jn(t,function(t,n,i){r(e,t,function(t,n){e=n,i(t)})},function(t){i(t,e)})}function yt(){var t=Z(arguments,f);return function(){var e=o(arguments),n=this,i=e[e.length-1];"function"==typeof i?e.pop():i=O,vt(t,e,function(t,e,i){e.apply(n,t.concat(function(t){var e=o(arguments,1);i(t,e)}))},function(t,e){i.apply(n,[t].concat(e))})}}function gt(t){return t}function mt(t,e){return function(n,i,r,o){o=o||O;var s,c=!1;n(i,function(n,i,o){r(n,function(i,r){i?o(i):t(r)&&!s?(c=!0,s=e(!0,n),o(null,we)):o()})},function(t){t?o(t):o(null,c?s:e(!1))})}}function Et(t,e){return e}function Ot(t){return function(e){var n=o(arguments,1);n.push(function(e){var n=o(arguments,1);"object"==typeof console&&(e?console.error&&console.error(e):console[t]&&G(n,function(e){console[t](e)}))}),f(e).apply(null,n)}}function Rt(t,e,n){function i(t){if(t)return n(t);var e=o(arguments,1);e.push(r),c.apply(this,e)}function r(t,e){return t?n(t):e?void s(i):n(null)}n=j(n||O);var s=f(t),c=f(e);r(null,!0)}function bt(t,e,n){n=j(n||O);var i=f(t),r=function(t){if(t)return n(t);var s=o(arguments,1);if(e.apply(this,s))return i(r);n.apply(null,[null].concat(s))};i(r)}function St(t,e,n){bt(t,function(){return!e.apply(this,arguments)},n)}function Tt(t,e,n){function i(t){if(t)return n(t);s(r)}function r(t,e){return t?n(t):e?void o(i):n(null)}n=j(n||O);var o=f(e),s=f(t);s(r)}function Dt(t){return function(e,n,i){return t(e,i)}}function Pt(t,e,n){un(t,Dt(f(e)),n)}function At(t,e,n,i){q(e)(t,Dt(f(n)),i)}function Nt(t){return p(t)?t:ce(function(e,n){var i=!0;e.push(function(){var t=arguments;i?le(function(){n.apply(null,t)}):n.apply(null,t)}),t.apply(this,e),i=!1})}function wt(t){return!t}function It(t){return function(e){return null==e?void 0:e[t]}}function kt(t,e,n,i){var r=new Array(e.length);t(e,function(t,e,i){n(t,function(t,n){r[e]=!!n,i(t)})},function(t){if(t)return i(t);for(var n=[],o=0;o<e.length;o++)r[o]&&n.push(e[o]);i(null,n)})}function Ct(t,e,n,i){var r=[];t(e,function(t,e,i){n(t,function(n,o){n?i(n):(o&&r.push({index:e,value:t}),i())})},function(t){t?i(t):i(null,Z(r.sort(function(t,e){return t.index-e.index}),It("value")))})}function Lt(t,e,n,i){(E(e)?kt:Ct)(t,e,f(n),i||O)}function xt(t,e){function n(t){if(t)return i(t);r(n)}var i=j(e||O),r=f(Nt(t));n()}function Mt(t,e,n,i){i=R(i||O);var r={},o=f(n);F(t,e,function(t,e,n){o(t,e,function(t,i){if(t)return n(t);r[e]=i,n()})},function(t){i(t,r)})}function jt(t,e){return e in t}function qt(t,e){var n=Object.create(null),i=Object.create(null);e=e||gt;var r=f(t),s=ce(function(t,s){var c=e.apply(null,t);jt(n,c)?le(function(){s.apply(null,n[c])}):jt(i,c)?i[c].push(s):(i[c]=[s],r.apply(null,t.concat(function(){var t=o(arguments);n[c]=t;var e=i[c];delete i[c];for(var r=0,s=e.length;r<s;r++)e[r].apply(null,t)})))});return s.memo=n,s.unmemoized=t,s}function Ft(t,e,n){n=n||O;var i=E(e)?[]:{};t(e,function(t,e,n){f(t)(function(t,r){arguments.length>2&&(r=o(arguments,1)),i[e]=r,n(t)})},function(t){n(t,i)})}function Ut(t,e){Ft(un,t,e)}function Bt(t,e,n){Ft(q(e),t,n)}function Vt(t,e){if(e=R(e||O),!qe(t))return e(new TypeError("First argument to race must be an array of functions"));if(!t.length)return e();for(var n=0,i=t.length;n<i;n++)f(t[n])(e)}function Ht(t,e,n,i){vt(o(t).reverse(),e,n,i)}function Yt(t){var e=f(t);return ce(function(t,n){return t.push(function(t,e){if(t)n(null,{error:t});else{var i;i=arguments.length<=2?e:o(arguments,1),n(null,{value:i})}}),e.apply(this,t)})}function Gt(t){var e;return qe(t)?e=Z(t,Yt):(e={},W(t,function(t,n){e[n]=Yt.call(this,t)})),e}function Wt(t,e,n,i){Lt(t,e,function(t,e){n(t,function(t,n){e(t,!n)})},i)}function zt(t){return function(){return t}}function Qt(t,e,n){function i(){c(function(t){t&&a++<s.times&&("function"!=typeof s.errorFilter||s.errorFilter(t))?setTimeout(i,s.intervalFunc(a)):n.apply(null,arguments)})}var r=5,o=0,s={times:r,intervalFunc:zt(o)};if(arguments.length<3&&"function"==typeof t?(n=e||O,e=t):(!function(t,e){if("object"==typeof e)t.times=+e.times||r,t.intervalFunc="function"==typeof e.interval?e.interval:zt(+e.interval||o),t.errorFilter=e.errorFilter;else{if("number"!=typeof e&&"string"!=typeof e)throw new Error("Invalid arguments for async.retry");t.times=+e||r}}(s,t),n=n||O),"function"!=typeof e)throw new Error("Invalid arguments for async.retry");var c=f(e),a=1;i()}function Jt(t,e){Ft(jn,t,e)}function Xt(t,e,n){function i(t,e){var n=t.criteria,i=e.criteria;return n<i?-1:n>i?1:0}var r=f(e);ln(t,function(t,e){r(t,function(n,i){if(n)return e(n);e(null,{value:t,criteria:i})})},function(t,e){if(t)return n(t);n(null,Z(e.sort(i),It("value")))})}function Zt(t,e,n){var i=f(t);return ce(function(r,o){function s(){var e=t.name||"anonymous",i=new Error('Callback function "'+e+'" timed out.');i.code="ETIMEDOUT",n&&(i.info=n),a=!0,o(i)}var c,a=!1;r.push(function(){a||(o.apply(null,arguments),clearTimeout(c))}),c=setTimeout(s,e),i.apply(null,r)})}function Kt(t,e,n,i){for(var r=-1,o=gi(yi((e-t)/(n||1)),0),s=Array(o);o--;)s[i?o:++r]=t,t+=n;return s}function $t(t,e,n,i){var r=f(n);pn(Kt(0,t,1),e,r,i)}function te(t,e,n,i){arguments.length<=3&&(i=n,n=e,e=qe(t)?[]:{}),i=R(i||O);var r=f(n);un(t,function(t,n,i){r(e,t,n,i)},function(t){i(t,e)})}function ee(t,e){var n,i=null;e=e||O,Qn(t,function(t,e){f(t)(function(t,r){n=arguments.length>2?o(arguments,1):r,i=t,e(!t)})},function(){e(i,n)})}function ne(t){return function(){return(t.unmemoized||t).apply(null,arguments)}}function ie(t,e,n){n=j(n||O);var i=f(e);if(!t())return n(null);var r=function(e){if(e)return n(e);if(t())return i(r);var s=o(arguments,1);n.apply(null,[null].concat(s))};i(r)}function re(t,e,n){ie(function(){return!t.apply(this,arguments)},e,n)}var oe,se=function(t){var e=o(arguments,1);return function(){var n=o(arguments);return t.apply(null,e.concat(n))}},ce=function(t){return function(){var e=o(arguments),n=e.pop();t.call(this,e,n)}},ae="function"==typeof r&&r,ue="object"==typeof t&&"function"==typeof t.nextTick;oe=ae?r:ue?t.nextTick:c;var le=a(oe),he="function"==typeof Symbol,pe="object"==typeof i&&i&&i.Object===Object&&i,fe="object"==typeof self&&self&&self.Object===Object&&self,de=pe||fe||Function("return this")(),_e=de.Symbol,ve=Object.prototype,ye=ve.hasOwnProperty,ge=ve.toString,me=_e?_e.toStringTag:void 0,Ee=Object.prototype,Oe=Ee.toString,Re="[object Null]",be="[object Undefined]",Se=_e?_e.toStringTag:void 0,Te="[object AsyncFunction]",De="[object Function]",Pe="[object GeneratorFunction]",Ae="[object Proxy]",Ne=9007199254740991,we={},Ie="function"==typeof Symbol&&Symbol.iterator,ke=function(t){return Ie&&t[Ie]&&t[Ie]()},Ce="[object Arguments]",Le=Object.prototype,xe=Le.hasOwnProperty,Me=Le.propertyIsEnumerable,je=T(function(){return arguments}())?T:function(t){return S(t)&&xe.call(t,"callee")&&!Me.call(t,"callee")},qe=Array.isArray,Fe="object"==typeof n&&n&&!n.nodeType&&n,Ue=Fe&&"object"==typeof e&&e&&!e.nodeType&&e,Be=Ue&&Ue.exports===Fe,Ve=Be?de.Buffer:void 0,He=Ve?Ve.isBuffer:void 0,Ye=He||D,Ge=9007199254740991,We=/^(?:0|[1-9]\d*)$/,ze={};ze["[object Float32Array]"]=ze["[object Float64Array]"]=ze["[object Int8Array]"]=ze["[object Int16Array]"]=ze["[object Int32Array]"]=ze["[object Uint8Array]"]=ze["[object Uint8ClampedArray]"]=ze["[object Uint16Array]"]=ze["[object Uint32Array]"]=!0,ze["[object Arguments]"]=ze["[object Array]"]=ze["[object ArrayBuffer]"]=ze["[object Boolean]"]=ze["[object DataView]"]=ze["[object Date]"]=ze["[object Error]"]=ze["[object Function]"]=ze["[object Map]"]=ze["[object Number]"]=ze["[object Object]"]=ze["[object RegExp]"]=ze["[object Set]"]=ze["[object String]"]=ze["[object WeakMap]"]=!1;var Qe="object"==typeof n&&n&&!n.nodeType&&n,Je=Qe&&"object"==typeof e&&e&&!e.nodeType&&e,Xe=Je&&Je.exports===Qe,Ze=Xe&&pe.process,Ke=function(){try{var t=Je&&Je.require&&Je.require("util").types;return t||Ze&&Ze.binding&&Ze.binding("util")}catch(t){}}(),$e=Ke&&Ke.isTypedArray,tn=$e?function(t){return function(e){return t(e)}}($e):A,en=Object.prototype,nn=en.hasOwnProperty,rn=Object.prototype,on=function(t,e){return function(n){return t(e(n))}}(Object.keys,Object),sn=Object.prototype,cn=sn.hasOwnProperty,an=U(F,1/0),un=function(t,e,n){(E(t)?B:an)(t,f(e),n)},ln=V(H),hn=d(ln),pn=Y(H),fn=U(pn,1),dn=d(fn),_n=function(t){return function(e,n,i){for(var r=-1,o=Object(e),s=i(e),c=s.length;c--;){var a=s[t?c:++r];if(!1===n(o[a],a,o))break}return e}}(),vn=function(t,e,n){function i(t,e){y.push(function(){a(t,e)})}function r(){if(0===y.length&&0===d)return n(null,p);for(;y.length&&d<e;){y.shift()()}}function s(t,e){var n=v[t];n||(n=v[t]=[]),n.push(e)}function c(t){G(v[t]||[],function(t){t()}),r()}function a(t,e){if(!_){var i=j(function(e,i){if(d--,arguments.length>2&&(i=o(arguments,1)),e){var r={};W(p,function(t,e){r[e]=t}),r[t]=i,_=!0,v=Object.create(null),n(e,r)}else p[t]=i,c(t)});d++;var r=f(e[e.length-1]);e.length>1?r(p,i):r(i)}}function u(e){var n=[];return W(t,function(t,i){qe(t)&&X(t,e,0)>=0&&n.push(i)}),n}"function"==typeof e&&(n=e,e=null),n=R(n||O);var l=k(t),h=l.length;if(!h)return n(null);e||(e=h);var p={},d=0,_=!1,v=Object.create(null),y=[],g=[],m={};W(t,function(e,n){if(!qe(e))return i(n,[e]),void g.push(n);var r=e.slice(0,e.length-1),o=r.length;if(0===o)return i(n,e),void g.push(n);m[n]=o,G(r,function(c){if(!t[c])throw new Error("async.auto task `"+n+"` has a non-existent dependency `"+c+"` in "+r.join(", "));s(c,function(){0===--o&&i(n,e)})})}),function(){for(var t,e=0;g.length;)t=g.pop(),e++,G(u(t),function(t){0==--m[t]&&g.push(t)});if(e!==h)throw new Error("async.auto cannot execute tasks due to a recursive dependency")}(),r()},yn="[object Symbol]",gn=1/0,mn=_e?_e.prototype:void 0,En=mn?mn.toString:void 0,On=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]"),Rn="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",bn="\\ud83c[\\udffb-\\udfff]",Sn="(?:\\ud83c[\\udde6-\\uddff]){2}",Tn="[\\ud800-\\udbff][\\udc00-\\udfff]",Dn="(?:[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]|\\ud83c[\\udffb-\\udfff])?",Pn="(?:\\u200d(?:"+["[^\\ud800-\\udfff]",Sn,Tn].join("|")+")[\\ufe0e\\ufe0f]?"+Dn+")*",An="[\\ufe0e\\ufe0f]?"+Dn+Pn,Nn="(?:"+["[^\\ud800-\\udfff]"+Rn+"?",Rn,Sn,Tn,"[\\ud800-\\udfff]"].join("|")+")",wn=RegExp(bn+"(?="+bn+")|"+Nn+An,"g"),In=/^\s+|\s+$/g,kn=/^(?:async\s+)?(function)?\s*[^\(]*\(\s*([^\)]*)\)/m,Cn=/,/,Ln=/(=.+)?(\s*)$/,xn=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;pt.prototype.removeLink=function(t){return t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,t.prev=t.next=null,this.length-=1,t},pt.prototype.empty=function(){for(;this.head;)this.shift();return this},pt.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,t.next?t.next.prev=e:this.tail=e,t.next=e,this.length+=1},pt.prototype.insertBefore=function(t,e){e.prev=t.prev,e.next=t,t.prev?t.prev.next=e:this.head=e,t.prev=e,this.length+=1},pt.prototype.unshift=function(t){this.head?this.insertBefore(this.head,t):ft(this,t)},pt.prototype.push=function(t){this.tail?this.insertAfter(this.tail,t):ft(this,t)},pt.prototype.shift=function(){return this.head&&this.removeLink(this.head)},pt.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},pt.prototype.toArray=function(){for(var t=Array(this.length),e=this.head,n=0;n<this.length;n++)t[n]=e.data,e=e.next;return t},pt.prototype.remove=function(t){for(var e=this.head;e;){var n=e.next;t(e)&&this.removeLink(e),e=n}return this};var Mn,jn=U(F,1),qn=function(){return yt.apply(null,o(arguments).reverse())},Fn=Array.prototype.concat,Un=function(t,e,n,i){i=i||O;var r=f(n);pn(t,e,function(t,e){r(t,function(t){return t?e(t):e(null,o(arguments,1))})},function(t,e){for(var n=[],r=0;r<e.length;r++)e[r]&&(n=Fn.apply(n,e[r]));return i(t,n)})},Bn=U(Un,1/0),Vn=U(Un,1),Hn=function(){var t=o(arguments),e=[null].concat(t);return function(){return arguments[arguments.length-1].apply(this,e)}},Yn=V(mt(gt,Et)),Gn=Y(mt(gt,Et)),Wn=U(Gn,1),zn=Ot("dir"),Qn=U(At,1),Jn=V(mt(wt,wt)),Xn=Y(mt(wt,wt)),Zn=U(Xn,1),Kn=V(Lt),$n=Y(Lt),ti=U($n,1),ei=function(t,e,n,i){i=i||O;var r=f(n);pn(t,e,function(t,e){r(t,function(n,i){return n?e(n):e(null,{key:i,val:t})})},function(t,e){for(var n={},r=Object.prototype.hasOwnProperty,o=0;o<e.length;o++)if(e[o]){var s=e[o].key,c=e[o].val;r.call(n,s)?n[s].push(c):n[s]=[c]}return i(t,n)})},ni=U(ei,1/0),ii=U(ei,1),ri=Ot("log"),oi=U(Mt,1/0),si=U(Mt,1);Mn=ue?t.nextTick:ae?r:c;var ci=a(Mn),ai=function(t,e){var n=f(t);return dt(function(t,e){n(t[0],e)},e,1)},ui=function(t,e){var n=ai(t,e);return n.push=function(t,e,i){if(null==i&&(i=O),"function"!=typeof i)throw new Error("task callback must be a function");if(n.started=!0,qe(t)||(t=[t]),0===t.length)return le(function(){n.drain()});e=e||0;for(var r=n._tasks.head;r&&e>=r.priority;)r=r.next;for(var o=0,s=t.length;o<s;o++){var c={data:t[o],priority:e,callback:i};r?n._tasks.insertBefore(r,c):n._tasks.push(c)}le(n.process)},delete n.unshift,n},li=V(Wt),hi=Y(Wt),pi=U(hi,1),fi=function(t,e){e||(e=t,t=null);var n=f(e);return ce(function(e,i){function r(t){n.apply(null,e.concat(t))}t?Qt(t,r,i):Qt(r,i)})},di=V(mt(Boolean,gt)),_i=Y(mt(Boolean,gt)),vi=U(_i,1),yi=Math.ceil,gi=Math.max,mi=U($t,1/0),Ei=U($t,1),Oi=function(t,e){function n(e){var n=f(t[r++]);e.push(j(i)),n.apply(null,e)}function i(i){if(i||r===t.length)return e.apply(null,arguments);n(o(arguments,1))}if(e=R(e||O),!qe(t))return e(new Error("First argument to waterfall must be an array of functions"));if(!t.length)return e();var r=0;n([])},Ri={apply:se,applyEach:hn,applyEachSeries:dn,asyncify:u,auto:vn,autoInject:ht,cargo:_t,compose:qn,concat:Bn,concatLimit:Un,concatSeries:Vn,constant:Hn,detect:Yn,detectLimit:Gn,detectSeries:Wn,dir:zn,doDuring:Rt,doUntil:St,doWhilst:bt,during:Tt,each:Pt,eachLimit:At,eachOf:un,eachOfLimit:F,eachOfSeries:jn,eachSeries:Qn,ensureAsync:Nt,every:Jn,everyLimit:Xn,everySeries:Zn,filter:Kn,filterLimit:$n,filterSeries:ti,forever:xt,groupBy:ni,groupByLimit:ei,groupBySeries:ii,log:ri,map:ln,mapLimit:pn,mapSeries:fn,mapValues:oi,mapValuesLimit:Mt,mapValuesSeries:si,memoize:qt,nextTick:ci,parallel:Ut,parallelLimit:Bt,priorityQueue:ui,queue:ai,race:Vt,reduce:vt,reduceRight:Ht,reflect:Yt,reflectAll:Gt,reject:li,rejectLimit:hi,rejectSeries:pi,retry:Qt,retryable:fi,seq:yt,series:Jt,setImmediate:le,some:di,someLimit:_i,someSeries:vi,sortBy:Xt,timeout:Zt,times:mi,timesLimit:$t,timesSeries:Ei,transform:te,tryEach:ee,unmemoize:ne,until:re,waterfall:Oi,whilst:ie,all:Jn,allLimit:Xn,allSeries:Zn,any:di,anyLimit:_i,anySeries:vi,find:Yn,findLimit:Gn,findSeries:Wn,forEach:Pt,forEachSeries:Qn,forEachLimit:At,forEachOf:un,forEachOfSeries:jn,forEachOfLimit:F,inject:vt,foldl:vt,foldr:Ht,select:Kn,selectLimit:$n,selectSeries:ti,wrapSync:u};n.default=Ri,n.apply=se,n.applyEach=hn,n.applyEachSeries=dn,n.asyncify=u,n.auto=vn,n.autoInject=ht,n.cargo=_t,n.compose=qn,n.concat=Bn,n.concatLimit=Un,n.concatSeries=Vn,n.constant=Hn,n.detect=Yn,n.detectLimit=Gn,n.detectSeries=Wn,n.dir=zn,n.doDuring=Rt,n.doUntil=St,n.doWhilst=bt,n.during=Tt,n.each=Pt,n.eachLimit=At,n.eachOf=un,n.eachOfLimit=F,n.eachOfSeries=jn,n.eachSeries=Qn,n.ensureAsync=Nt,n.every=Jn,n.everyLimit=Xn,n.everySeries=Zn,n.filter=Kn,n.filterLimit=$n,n.filterSeries=ti,n.forever=xt,n.groupBy=ni,n.groupByLimit=ei,n.groupBySeries=ii,n.log=ri,n.map=ln,n.mapLimit=pn,n.mapSeries=fn,n.mapValues=oi,n.mapValuesLimit=Mt,n.mapValuesSeries=si,n.memoize=qt,n.nextTick=ci,n.parallel=Ut,n.parallelLimit=Bt,n.priorityQueue=ui,n.queue=ai,n.race=Vt,n.reduce=vt,n.reduceRight=Ht,n.reflect=Yt,n.reflectAll=Gt,n.reject=li,n.rejectLimit=hi,n.rejectSeries=pi,n.retry=Qt,n.retryable=fi,n.seq=yt,n.series=Jt,n.setImmediate=le,n.some=di,n.someLimit=_i,n.someSeries=vi,n.sortBy=Xt,n.timeout=Zt,n.times=mi,n.timesLimit=$t,n.timesSeries=Ei,n.transform=te,n.tryEach=ee,n.unmemoize=ne,n.until=re,n.waterfall=Oi,n.whilst=ie,n.all=Jn,n.allLimit=Xn,n.allSeries=Zn,n.any=di,n.anyLimit=_i,n.anySeries=vi,n.find=Yn,n.findLimit=Gn,n.findSeries=Wn,n.forEach=Pt,n.forEachSeries=Qn,n.forEachLimit=At,n.forEachOf=un,n.forEachOfSeries=jn,n.forEachOfLimit=F,n.inject=vt,n.foldl=vt,n.foldr=Ht,n.select=Kn,n.selectLimit=$n,n.selectSeries=ti,n.wrapSync=u,Object.defineProperty(n,"__esModule",{value:!0})})}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t("timers").setImmediate)},{_process:7,timers:30}],30:[function(t,e,n){(function(e,i){function r(t,e){this._id=t,this._clearFn=e}var o=t("process/browser.js").nextTick,s=Function.prototype.apply,c=Array.prototype.slice,a={},u=0;n.setTimeout=function(){return new r(s.call(setTimeout,window,arguments),clearTimeout)},n.setInterval=function(){return new r(s.call(setInterval,window,arguments),clearInterval)},n.clearTimeout=n.clearInterval=function(t){t.close()},r.prototype.unref=r.prototype.ref=function(){},r.prototype.close=function(){this._clearFn.call(window,this._id)},n.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},n.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},n._unrefActive=n.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},n.setImmediate="function"==typeof e?e:function(t){var e=u++,i=!(arguments.length<2)&&c.call(arguments,1);return a[e]=!0,o(function(){a[e]&&(i?t.apply(null,i):t.call(null),n.clearImmediate(e))}),e},n.clearImmediate="function"==typeof i?i:function(t){delete a[t]}}).call(this,t("timers").setImmediate,t("timers").clearImmediate)},{"process/browser.js":7,timers:30}],31:[function(t,e,n){window.sharedb=t("../../../node_modules/sharedb/lib/client")},{"../../../node_modules/sharedb/lib/client":10}]},{},[31]);