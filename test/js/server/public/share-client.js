!function i(r,o,s){function c(e,t){if(!o[e]){if(!r[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(a)return a(e,!0);throw(n=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",n}n=o[e]={exports:{}},r[e][0].call(n.exports,function(t){return c(r[e][1][t]||t)},n,n.exports,i,r,o,s)}return o[e].exports}for(var a="function"==typeof require&&require,t=0;t<s.length;t++)c(s[t]);return c}({1:[function(t,e,n){"use strict";var i,r="object"==typeof Reflect?Reflect:null,a=r&&"function"==typeof r.apply?r.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};i=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var o=Number.isNaN||function(t){return t!=t};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(r,o){return new Promise(function(t,e){function n(){void 0!==i&&r.removeListener("error",i),t([].slice.call(arguments))}var i;"error"!==o&&(i=function(t){r.removeListener(o,n),e(t)},r.once("error",i)),r.once(o,n)})},(s.EventEmitter=s).prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var c=10;function u(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function l(t){return void 0===t._maxListeners?s.defaultMaxListeners:t._maxListeners}function p(t,e,n,i){var r,o;return u(n),void 0===(r=t._events)?(r=t._events=Object.create(null),t._eventsCount=0):(void 0!==r.newListener&&(t.emit("newListener",e,n.listener||n),r=t._events),o=r[e]),void 0===o?(o=r[e]=n,++t._eventsCount):("function"==typeof o?o=r[e]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),0<(n=l(t))&&o.length>n&&!o.warned&&(o.warned=!0,(n=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",n.emitter=t,n.type=e,n.count=o.length,n=n,console&&console.warn&&console.warn(n))),t}function h(t,e,n){t={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},e=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(t);return e.listener=n,t.wrapFn=e}function f(t,e,n){t=t._events;if(void 0===t)return[];e=t[e];return void 0===e?[]:"function"==typeof e?n?[e.listener||e]:[e]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(e):_(e,e.length)}function d(t){var e=this._events;if(void 0!==e){t=e[t];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function _(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");c=t}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i,r="error"===t,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){if(0<e.length&&(i=e[0]),i instanceof Error)throw i;r=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw r.context=i,r}t=o[t];if(void 0===t)return!1;if("function"==typeof t)a(t,this,e);else for(var s=t.length,c=_(t,s),n=0;n<s;++n)a(c[n],this,e);return!0},s.prototype.addListener=function(t,e){return p(this,t,e,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(t,e){return p(this,t,e,!0)},s.prototype.once=function(t,e){return u(e),this.on(t,h(this,t,e)),this},s.prototype.prependOnceListener=function(t,e){return u(e),this.prependListener(t,h(this,t,e)),this},s.prototype.removeListener=function(t,e){var n,i,r,o,s;if(u(e),void 0===(i=this._events))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,o=n.length-1;0<=o;o--)if(n[o]===e||n[o].listener===e){s=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,r),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,s||e)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(t){var e,n=this._events;if(void 0===n)return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){for(var i,r=Object.keys(n),o=0;o<r.length;++o)"removeListener"!==(i=r[o])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(o=e.length-1;0<=o;o--)this.removeListener(t,e[o]);return this},s.prototype.listeners=function(t){return f(this,t,!0)},s.prototype.rawListeners=function(t){return f(this,t,!1)},s.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):d.call(t,e)},s.prototype.listenerCount=d,s.prototype.eventNames=function(){return 0<this._eventsCount?i(this._events):[]}},{}],2:[function(t,e,n){var c=e.exports=function(t,e){if(e=e||16,void 0===t&&(t=128),t<=0)return"0";for(var n=Math.log(Math.pow(2,t))/Math.log(e),i=2;n===1/0;i*=2)n=Math.log(Math.pow(2,t/i))/Math.log(e)*i;for(var r=n-Math.floor(n),o="",i=0;i<Math.floor(n);i++)o=Math.floor(Math.random()*e).toString(e)+o;r&&(s=Math.pow(e,r),o=Math.floor(Math.random()*s).toString(e)+o);var s=parseInt(o,e);return s!==1/0&&s>=Math.pow(2,t)?c(t,e):o};c.rack=function(i,r,o){function n(t){var e=0;do{if(10<e++){if(!o)throw new Error("too many ID collisions, use more bits");i+=o}var n=c(i,r)}while(Object.hasOwnProperty.call(s,n));return s[n]=t,n}var s=n.hats={};return n.get=function(t){return n.hats[t]},n.set=function(t,e){return n.hats[t]=e,n},n.bits=i||128,n.base=r||16,n}},{}],3:[function(t,e,n){e.exports=function(t,_,v,y){var g=t.transformX=function(t,e){v(t),v(e);for(var n,i,r,o=[],s=0;s<e.length;s++){for(var c=e[s],a=[],u=0;u<t.length;){var l=[];if(n=t[u],r=l,_(a,n,i=c,"left"),_(r,i,n,"right"),u++,1!==l.length){if(0===l.length){for(var p=u;p<t.length;p++)y(a,t[p]);c=null;break}for(var h=g(t.slice(u),l),f=0;f<h[0].length;f++)y(a,h[0][f]);for(var d=0;d<h[1].length;d++)y(o,h[1][d]);c=null;break}c=l[0]}null!=c&&y(o,c),t=a}return[t,o]};t.transform=function(t,e,n){if("left"!==n&&"right"!==n)throw new Error("type must be 'left' or 'right'");return 0===e.length?t:1===t.length&&1===e.length?_([],t[0],e[0],n):"left"===n?g(t,e)[0]:g(e,t)[1]}}},{}],4:[function(t,e,n){e.exports={type:t("./json0")}},{"./json0":5}],5:[function(t,e,n){function d(t){return"[object Array]"==Object.prototype.toString.call(t)}function _(t){return JSON.parse(JSON.stringify(t))}var v={name:"json0",uri:"http://sharejs.org/types/JSONv0"},y={};function g(t){t.t="text0";var e={p:t.p.pop()};null!=t.si&&(e.i=t.si),null!=t.sd&&(e.d=t.sd),t.o=[e]}function m(t){t.p.push(t.o[0].p),null!=t.o[0].i&&(t.si=t.o[0].i),null!=t.o[0].d&&(t.sd=t.o[0].d),delete t.t,delete t.o}v.registerSubtype=function(t){y[t.name]=t},v.create=function(t){return void 0===t?null:_(t)},v.invertComponent=function(t){var e={p:t.p};return t.t&&y[t.t]&&(e.t=t.t,e.o=y[t.t].invert(t.o)),void 0!==t.si&&(e.sd=t.si),void 0!==t.sd&&(e.si=t.sd),void 0!==t.oi&&(e.od=t.oi),void 0!==t.od&&(e.oi=t.od),void 0!==t.li&&(e.ld=t.li),void 0!==t.ld&&(e.li=t.ld),void 0!==t.na&&(e.na=-t.na),void 0!==t.lm&&(e.lm=t.p[t.p.length-1],e.p=t.p.slice(0,t.p.length-1).concat([t.lm])),e},v.invert=function(t){for(var e=t.slice().reverse(),n=[],i=0;i<e.length;i++)n.push(v.invertComponent(e[i]));return n},v.checkValidOp=function(t){for(var e=0;e<t.length;e++)if(!d(t[e].p))throw new Error("Missing path")},v.checkList=function(t){if(!d(t))throw new Error("Referenced element not a list")},v.checkObj=function(t){if(!(e=t)||e.constructor!==Object)throw new Error("Referenced element not an object (it was "+JSON.stringify(t)+")");var e},v.apply=function(t,e){v.checkValidOp(e),e=_(e);for(var n={data:t},i=0;i<e.length;i++){var r=e[i];null==r.si&&null==r.sd||g(r);for(var o,s=n,c="data",a=0;a<r.p.length;a++){var u=r.p[a],l=s,s=s[c],c=u;if(null==l)throw new Error("Path invalid")}if(r.t&&void 0!==r.o&&y[r.t])s[c]=y[r.t].apply(s[c],r.o);else if(void 0!==r.na){if("number"!=typeof s[c])throw new Error("Referenced element not a number");s[c]+=r.na}else if(void 0!==r.li&&void 0!==r.ld)v.checkList(s),s[c]=r.li;else if(void 0!==r.li)v.checkList(s),s.splice(c,0,r.li);else if(void 0!==r.ld)v.checkList(s),s.splice(c,1);else if(void 0!==r.lm)v.checkList(s),r.lm!=c&&(o=s[c],s.splice(c,1),s.splice(r.lm,0,o));else if(void 0!==r.oi)v.checkObj(s),s[c]=r.oi;else{if(void 0===r.od)throw new Error("invalid / missing instruction in op");v.checkObj(s),delete s[c]}}return n.data},v.shatter=function(t){for(var e=[],n=0;n<t.length;n++)e.push([t[n]]);return e},v.incrementalApply=function(t,e,n){for(var i=0;i<e.length;i++){var r=[e[i]];n(r,t=v.apply(t,r))}return t};var o=v.pathMatches=function(t,e,n){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i]&&(!n||i!==t.length-1))return!1;return!0};v.append=function(t,e){if(e=_(e),0!==t.length){var n=t[t.length-1];if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(g(e),g(n)),o(e.p,n.p))if(e.t&&n.t&&e.t===n.t&&y[e.t]){if(n.o=y[e.t].compose(n.o,e.o),null!=e.si||null!=e.sd){for(var i=e.p,r=0;r<n.o.length-1;r++)e.o=[n.o.pop()],e.p=i.slice(),m(e),t.push(e);m(n)}}else null!=n.na&&null!=e.na?t[t.length-1]={p:n.p,na:n.na+e.na}:void 0!==n.li&&void 0===e.li&&e.ld===n.li?void 0!==n.ld?delete n.li:t.pop():void 0!==n.od&&void 0===n.oi&&void 0!==e.oi&&void 0===e.od?n.oi=e.oi:void 0!==n.oi&&void 0!==e.od?void 0!==e.oi?n.oi=e.oi:void 0!==n.od?delete n.oi:t.pop():void 0!==e.lm&&e.p[e.p.length-1]===e.lm||t.push(e);else null==e.si&&null==e.sd||null==n.si&&null==n.sd||(m(e),m(n)),t.push(e)}else t.push(e)},v.compose=function(t,e){v.checkValidOp(t),v.checkValidOp(e);for(var n=_(t),i=0;i<e.length;i++)v.append(n,e[i]);return n},v.normalize=function(t){var e=[];t=d(t)?t:[t];for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=[]),v.append(e,i)}return e},v.commonLengthForOps=function(t,e){var n=t.p.length,i=e.p.length;if(null==t.na&&!t.t||n++,null==e.na&&!e.t||i++,0===n)return-1;if(0===i)return null;n--,i--;for(var r=0;r<n;r++){var o=t.p[r];if(i<=r||o!==e.p[r])return null}return n},v.canOpAffectPath=function(t,e){return null!=v.commonLengthForOps({p:e},t)},v.transformComponent=function(t,e,n,i){e=_(e);var r=v.commonLengthForOps(n,e),o=v.commonLengthForOps(e,n),s=e.p.length,c=n.p.length;if(null==e.na&&!e.t||s++,null==n.na&&!n.t||c++,null!=o&&s<c&&e.p[o]==n.p[o]&&(void 0!==e.ld?((a=_(n)).p=a.p.slice(s),e.ld=v.apply(_(e.ld),[a])):void 0!==e.od&&((a=_(n)).p=a.p.slice(s),e.od=v.apply(_(e.od),[a]))),null!=r){var o=s==c,a=n;if(null==e.si&&null==e.sd||null==n.si&&null==n.sd||(g(e),g(a=_(n))),a.t&&y[a.t]){if(e.t&&e.t===a.t){var u=y[e.t].transform(e.o,a.o,i);if(null!=e.si||null!=e.sd)for(var l=e.p,p=0;p<u.length;p++)e.o=[u[p]],e.p=l.slice(),m(e),v.append(t,e);else(!d(u)||0<u.length)&&(e.o=u,v.append(t,e));return t}}else if(void 0===n.na)if(void 0!==n.li&&void 0!==n.ld){if(n.p[r]===e.p[r]){if(!o)return t;if(void 0!==e.ld){if(void 0===e.li||"left"!==i)return t;e.ld=_(n.li)}}}else if(void 0!==n.li)void 0!==e.li&&void 0===e.ld&&o&&e.p[r]===n.p[r]?"right"===i&&e.p[r]++:n.p[r]<=e.p[r]&&e.p[r]++,void 0!==e.lm&&o&&n.p[r]<=e.lm&&e.lm++;else if(void 0!==n.ld){if(void 0!==e.lm&&o){if(n.p[r]===e.p[r])return t;var l=n.p[r],h=e.p[r];(l<(f=e.lm)||l===f&&h<f)&&e.lm--}if(n.p[r]<e.p[r])e.p[r]--;else if(n.p[r]===e.p[r]){if(c<s)return t;if(void 0!==e.ld){if(void 0===e.li)return t;delete e.ld}}}else if(void 0!==n.lm)if(void 0!==e.lm&&s===c){var h=e.p[r],f=e.lm,s=n.p[r],c=n.lm;if(s!==c)if(h===s){if("left"!==i)return t;e.p[r]=c,h===f&&(e.lm=c)}else s<h&&e.p[r]--,c<h?e.p[r]++:h===c&&c<s&&(e.p[r]++,h===f&&e.lm++),(s<f||f===s&&h<f)&&e.lm--,c<f?e.lm++:f===c&&(s<c&&h<f||c<s&&f<h?"right"===i&&e.lm++:h<f?e.lm++:f===s&&e.lm--)}else void 0!==e.li&&void 0===e.ld&&o?(h=n.p[r],f=n.lm,h<(l=e.p[r])&&e.p[r]--,f<l&&e.p[r]++):(h=n.p[r],f=n.lm,(l=e.p[r])===h?e.p[r]=f:(h<l&&e.p[r]--,(f<l||l===f&&f<h)&&e.p[r]++));else if(void 0!==n.oi&&void 0!==n.od){if(e.p[r]===n.p[r]){if(void 0===e.oi||!o)return t;if("right"===i)return t;e.od=n.oi}}else if(void 0!==n.oi){if(void 0!==e.oi&&e.p[r]===n.p[r]){if("left"!==i)return t;v.append(t,{p:e.p,od:n.oi})}}else if(void 0!==n.od&&e.p[r]==n.p[r]){if(!o)return t;if(void 0===e.oi)return t;delete e.od}}return v.append(t,e),t},t("./bootstrapTransform")(v,v.transformComponent,v.checkValidOp,v.append);t=t("./text0");v.registerSubtype(t),e.exports=v},{"./bootstrapTransform":3,"./text0":6}],6:[function(t,e,n){function o(t,e,n){return t.slice(0,e)+n+t.slice(e)}function s(t){if("number"!=typeof t.p)throw new Error("component missing position field");if("string"==typeof t.i==("string"==typeof t.d))throw new Error("component needs an i or d field");if(t.p<0)throw new Error("position cannot be negative")}function c(t){for(var e=0;e<t.length;e++)s(t[e])}var i=e.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(t){if(null!=t&&"string"!=typeof t)throw new Error("Initial data must be a string");return t||""}};i.apply=function(t,e){var n;c(e);for(var i=0;i<e.length;i++){var r=e[i];if(null!=r.i)t=o(t,r.p,r.i);else{if(n=t.slice(r.p,r.p+r.d.length),r.d!==n)throw new Error("Delete component '"+r.d+"' does not match deleted text '"+n+"'");t=t.slice(0,r.p)+t.slice(r.p+r.d.length)}}return t};var a=i._append=function(t,e){var n;""!==e.i&&""!==e.d&&(0===t.length?t.push(e):null!=(n=t[t.length-1]).i&&null!=e.i&&n.p<=e.p&&e.p<=n.p+n.i.length?t[t.length-1]={i:o(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=n.p&&n.p<=e.p+e.d.length?t[t.length-1]={d:o(e.d,n.p-e.p,n.d),p:e.p}:t.push(e))};i.compose=function(t,e){c(t),c(e);for(var n=t.slice(),i=0;i<e.length;i++)a(n,e[i]);return n},i.normalize=function(t){var e=[];null==t.i&&null==t.p||(t=[t]);for(var n=0;n<t.length;n++){var i=t[n];null==i.p&&(i.p=0),a(e,i)}return e};function u(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length}i.transformCursor=function(t,e,n){for(var i="right"===n,r=0;r<e.length;r++)t=u(t,e[r],i);return t};e=i._tc=function(t,e,n,i){if(s(e),s(n),null!=e.i)a(t,{i:e.i,p:u(e.p,n,"right"===i)});else if(null!=n.i){var r=e.d;e.p<n.p&&(a(t,{d:r.slice(0,n.p-e.p),p:e.p}),r=r.slice(n.p-e.p)),""!==r&&a(t,{d:r,p:e.p+n.i.length})}else if(e.p>=n.p+n.d.length)a(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)a(t,e);else{var o={d:"",p:e.p};e.p<n.p&&(o.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(o.d+=e.d.slice(n.p+n.d.length-e.p));i=Math.max(e.p,n.p),r=Math.min(e.p+e.d.length,n.p+n.d.length);if(e.d.slice(i-e.p,r-e.p)!==n.d.slice(i-n.p,r-n.p))throw new Error("Delete ops delete different text in the same region of the document");""!==o.d&&(o.p=u(o.p,n),a(t,o))}return t};i.invert=function(t){t=t.slice().reverse();for(var e,n=0;n<t.length;n++)t[n]=null!=(e=t[n]).i?{d:e.i,p:e.p}:{i:e.d,p:e.p};return t},t("./bootstrapTransform")(i,e,c,a)},{"./bootstrapTransform":3}],7:[function(t,e,n){var i,r,e=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function c(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(t){r=s}}();var a,u=[],l=!1,p=-1;function h(){l&&a&&(l=!1,a.length?u=a.concat(u):p=-1,u.length&&f())}function f(){if(!l){var t=c(h);l=!0;for(var e=u.length;e;){for(a=u,u=[];++p<e;)a&&a[p].run();p=-1,e=u.length}a=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function _(){}e.nextTick=function(t){var e=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];u.push(new d(t,e)),1!==u.length||l||c(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},e.title="browser",e.browser=!0,e.env={},e.argv=[],e.version="",e.versions={},e.on=_,e.addListener=_,e.once=_,e.off=_,e.removeListener=_,e.removeAllListeners=_,e.emit=_,e.prependListener=_,e.prependOnceListener=_,e.listeners=function(t){return[]},e.binding=function(t){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(t){throw new Error("process.chdir is not supported")},e.umask=function(){return 0}},{}],8:[function(g,m,t){(function(y){(function(){var r=g("./doc"),s=g("./query"),n=g("./presence/presence"),o=g("./presence/doc-presence"),c=g("./snapshot-request/snapshot-version-request"),a=g("./snapshot-request/snapshot-timestamp-request"),e=g("../emitter"),u=g("../error"),i=g("../types"),l=g("../util"),p=g("../logger"),h=u.CODES;function f(t){return 0===t.readyState||1===t.readyState?"connecting":"disconnected"}function t(t){e.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._snapshotRequests={},this.seq=1,this.id=null,this.agent=null,this.debug=!1,this.state=f(t),this.bindToSocket(t)}function d(t,e){var n=new Error(t.message);return n.code=t.code,e&&(n.data=e),n}function _(t){return t.hasPending()}function v(t){return t.hasWritePending()}m.exports=t,e.mixin(t),t.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null);var e=f(this.socket=t);this._setState(e),this.canSend=!1;var i=this;t.onmessage=function(e){try{var t="string"==typeof e.data?JSON.parse(e.data):e.data}catch(t){return void p.warn("Failed to parse message",e)}i.debug&&p.info("RECV",JSON.stringify(t));var n={data:t};if(i.emit("receive",n),n.data)try{i.handleMessage(n.data)}catch(t){y.nextTick(function(){i.emit("error",t)})}},1===t.readyState&&i._initializeHandshake(),t.onopen=function(){i._setState("connecting"),i._initializeHandshake()},t.onerror=function(t){i.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?i._setState("closed",t):"stopped"===t||"Stopped by server"===t?i._setState("stopped",t):i._setState("disconnected",t)}},t.prototype.handleMessage=function(t){var e,n,i=null;switch(t.error&&(i=d(t.error,t),delete t.error),t.a){case"init":return this._handleLegacyInit(t);case"hs":return this._handleHandshake(i,t);case"qf":return void((e=this.queries[t.id])&&e._handleFetch(i,t.data,t.extra));case"qs":return void((e=this.queries[t.id])&&e._handleSubscribe(i,t.data,t.extra));case"qu":return;case"q":return(e=this.queries[t.id])?i?e._handleError(i):(t.diff&&e._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&e._handleExtra(t.extra))):void 0;case"bf":return this._handleBulkMessage(i,t,"_handleFetch");case"bs":return this._handleBulkMessage(i,t,"_handleSubscribe");case"bu":return this._handleBulkMessage(i,t,"_handleUnsubscribe");case"nf":case"nt":return this._handleSnapshotFetch(i,t);case"f":return void((n=this.getExisting(t.c,t.d))&&n._handleFetch(i,t.data));case"s":return void((n=this.getExisting(t.c,t.d))&&n._handleSubscribe(i,t.data));case"u":return void((n=this.getExisting(t.c,t.d))&&n._handleUnsubscribe(i));case"op":return void((n=this.getExisting(t.c,t.d))&&n._handleOp(i,t));case"p":return this._handlePresence(i,t);case"ps":return this._handlePresenceSubscribe(i,t);case"pu":return this._handlePresenceUnsubscribe(i,t);case"pr":return this._handlePresenceRequest(i,t);default:p.warn("Ignoring unrecognized message",t)}},t.prototype._handleBulkMessage=function(t,e,n){if(e.data)for(var i in e.data){var r=e.data[i];(s=this.getExisting(e.c,i))&&(t?s[n](t):r.error?s[n](d(r.error)):s[n](null,r))}else if(Array.isArray(e.b))for(var o=0;o<e.b.length;o++){i=e.b[o];(s=this.getExisting(e.c,i))&&s[n](t)}else if(e.b)for(var i in e.b){var s;(s=this.getExisting(e.c,i))&&s[n](t)}else p.error("Invalid bulk message",e)},t.prototype._reset=function(){this.agent=null},t.prototype._setState=function(t,e){if(this.state!==t){if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state){var n=new u(h.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+t);return this.emit("error",n)}for(var i in this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk(),this.queries)this.queries[i]._onConnectionStateChanged();for(var r in this.collections){var o=this.collections[r];for(i in o)o[i]._onConnectionStateChanged()}for(var s in this._presences)this._presences[s]._onConnectionStateChanged();for(var i in this._snapshotRequests)this._snapshotRequests[i]._onConnectionStateChanged();this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},t.prototype.startBulk=function(){this.bulk||(this.bulk={})},t.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},t.prototype._sendBulk=function(t,e,n){if(n){var i,r,o,s=[],c={},a=0;for(r in n){var u=n[r];null==u?s.push(r):(c[r]=u,i=r,a++)}1===s.length?(r=s[0],this.send({a:t,c:e,d:r})):s.length&&this.send({a:"b"+t,c:e,b:s}),1===a?(o=c[i],this.send({a:t,c:e,d:i,v:o})):a&&this.send({a:"b"+t,c:e,b:c})}},t.prototype._sendAction=function(t,e,n){if(this._addDoc(e),this.bulk){var i=this.bulk[e.collection]||(this.bulk[e.collection]={}),r=i[t]||(i[t]={}),i=r.hasOwnProperty(e.id);return r[e.id]=n,i}n={a:t,c:e.collection,d:e.id,v:n};this.send(n)},t.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},t.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},t.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},t.prototype.sendOp=function(t,e){this._addDoc(t);t={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq};e.op&&(t.op=e.op),e.create&&(t.create=e.create),e.del&&(t.del=e.del),this.send(t)},t.prototype.send=function(t){this.debug&&p.info("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},t.prototype.close=function(){this.socket.close()},t.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},t.prototype.get=function(t,e){var n=this.collections[t]||(this.collections[t]={}),i=n[e];return i||(i=n[e]=new r(this,t,e),this.emit("doc",i)),i},t.prototype._destroyDoc=function(t){l.digAndRemove(this.collections,t.collection,t.id)},t.prototype._addDoc=function(t){var e=this.collections[t.collection];(e=e||(this.collections[t.collection]={}))[t.id]!==t&&(e[t.id]=t)},t.prototype._createQuery=function(t,e,n,i,r){var o=this.nextQueryId++,r=new s(t,this,o,e,n,i,r);return(this.queries[o]=r).send(),r},t.prototype._destroyQuery=function(t){delete this.queries[t.id]},t.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("qf",t,e,n,i)},t.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("qs",t,e,n,i)},t.prototype.hasPending=function(){return!!(this._firstDoc(_)||this._firstQuery(_)||this._firstSnapshotRequest())},t.prototype.hasWritePending=function(){return!!this._firstDoc(v)},t.prototype.whenNothingPending=function(t){var e=this._firstDoc(_);e?e.once("nothing pending",this._nothingPendingRetry(t)):(e=this._firstQuery(_))?e.once("ready",this._nothingPendingRetry(t)):(e=this._firstSnapshotRequest())?e.once("ready",this._nothingPendingRetry(t)):y.nextTick(t)},t.prototype._nothingPendingRetry=function(t){var e=this;return function(){y.nextTick(function(){e.whenNothingPending(t)})}},t.prototype._firstDoc=function(t){for(var e in this.collections){var n,i=this.collections[e];for(n in i){var r=i[n];if(t(r))return r}}},t.prototype._firstQuery=function(t){for(var e in this.queries){var n=this.queries[e];if(t(n))return n}},t.prototype._firstSnapshotRequest=function(){for(var t in this._snapshotRequests)return this._snapshotRequests[t]},t.prototype.fetchSnapshot=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,i=new c(this,r,t,e,n,i);(this._snapshotRequests[i.requestId]=i).send()},t.prototype.fetchSnapshotByTimestamp=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,i=new a(this,r,t,e,n,i);(this._snapshotRequests[i.requestId]=i).send()},t.prototype._handleSnapshotFetch=function(t,e){var n=this._snapshotRequests[e.id];n&&(delete this._snapshotRequests[e.id],n._handleResponse(t,e))},t.prototype._handleLegacyInit=function(t){t.protocolMinor||this._initialize(t)},t.prototype._initializeHandshake=function(){this.send({a:"hs",id:this.id})},t.prototype._handleHandshake=function(t,e){if(t)return this.emit("error",t);this._initialize(e)},t.prototype._initialize=function(t){return 1!==t.protocol?this.emit("error",new u(h.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+t.protocol)):i.map[t.type]!==i.defaultType?this.emit("error",new u(h.ERR_DEFAULT_TYPE_MISMATCH,t.type+" does not match the server default type")):"string"!=typeof t.id?this.emit("error",new u(h.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string")):(this.id=t.id,void this._setState("connected"))},t.prototype.getPresence=function(t){var e=this;return l.digOrCreate(this._presences,t,function(){return new n(e,t)})},t.prototype.getDocPresence=function(t,e){var n=o.channel(t,e),i=this;return l.digOrCreate(this._presences,n,function(){return new o(i,t,e)})},t.prototype._sendPresenceAction=function(t,e,n){this._addPresence(n);e={a:t,ch:n.channel,seq:e};return this.send(e),e.seq},t.prototype._addPresence=function(t){l.digOrCreate(this._presences,t.channel,function(){return t})},t.prototype._handlePresenceSubscribe=function(t,e){var n=l.dig(this._presences,e.ch);n&&n._handleSubscribe(t,e.seq)},t.prototype._handlePresenceUnsubscribe=function(t,e){var n=l.dig(this._presences,e.ch);n&&n._handleUnsubscribe(t,e.seq)},t.prototype._handlePresence=function(t,e){var n=l.dig(this._presences,e.ch);n&&n._receiveUpdate(t,e)},t.prototype._handlePresenceRequest=function(t,e){var n=l.dig(this._presences,e.ch);n&&n._broadcastAllLocalPresence(t,e)}}).call(this)}).call(this,g("_process"))},{"../emitter":21,"../error":22,"../logger":23,"../types":27,"../util":28,"./doc":9,"./presence/doc-presence":11,"./presence/presence":14,"./query":17,"./snapshot-request/snapshot-timestamp-request":19,"./snapshot-request/snapshot-version-request":20,_process:7}],9:[function(c,h,t){(function(s){(function(){var i=c("../emitter"),e=c("../logger"),a=c("../error"),u=c("../types"),r=c("../util"),l=a.CODES;function t(t,e,n){i.EventEmitter.call(this),this.connection=t,this.collection=e,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=[],this.inflightUnsubscribe=[],this.pendingFetch=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1}function n(t,e,n){var i;e?(i=t.pop(),t.push(function(t){i&&i(t),n&&n(t)})):t.push(n)}function p(t,e){return t.del?(delete(n=e).op,delete n.create,void delete n.del):e.del?new a(l.ERR_DOC_WAS_DELETED,"Document was deleted"):e.create?new a(l.ERR_DOC_ALREADY_CREATED,"Document already created"):e.op?t.create?new a(l.ERR_DOC_ALREADY_CREATED,"Document already created"):void(t.type.transformX?(i=t.type.transformX(t.op,e.op),t.op=i[0],e.op=i[1]):(n=t.type.transform(t.op,e.op,"left"),i=t.type.transform(e.op,t.op,"right"),t.op=n,e.op=i)):void 0;var n,i}function o(t,e){for(var n=!1,i=0;i<t.length;i++){var r=t[i];r&&(r(e),n=!0)}return n}h.exports=t,i.mixin(t),t.prototype.destroy=function(e){var n=this;n.whenNothingPending(function(){n.wantSubscribe?n.unsubscribe(function(t){return t?e?e(t):n.emit("error",t):(n.connection._destroyDoc(n),n.emit("destroy"),void(e&&e()))}):(n.connection._destroyDoc(n),n.emit("destroy"),e&&e())})},t.prototype._setType=function(t){if("string"==typeof t&&(t=u.map[t]),t)this.type=t;else{if(null!==t){var e=new a(l.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+t);return this.emit("error",e)}this.type=t,this.data=void 0}},t.prototype.ingestSnapshot=function(t,e){if(!t)return e&&e();if("number"!=typeof t.v){var n=new a(l.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return e?e(n):this.emit("error",n)}if(this.type||this.hasWritePending()){if(null!=this.version)return t.v>this.version?this.fetch(e):e&&e();if(this.hasWritePending())return e&&this.once("no write pending",e);n=new a(l.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return e?e(n):this.emit("error",n)}if(this.version>t.v)return e&&e();this.version=t.v;n=void 0===t.type?u.defaultType:t.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),e&&e()},t.prototype.whenNothingPending=function(t){var e=this;s.nextTick(function(){e.hasPending()?e.once("nothing pending",t):t()})},t.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length)},t.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},t.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},t.prototype._emitResponseError=function(t,e){return t&&t.code===l.ERR_SNAPSHOT_READ_SILENT_REJECTION?(this.wantSubscribe=!1,e&&e(),void this._emitNothingPending()):e?(e(t),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",t))},t.prototype._handleFetch=function(t,e){var n=this.inflightFetch.shift();if(t)return this._emitResponseError(t,n);this.ingestSnapshot(e,n),this._emitNothingPending()},t.prototype._handleSubscribe=function(t,e){var n=this.inflightSubscribe.shift();if(t)return this._emitResponseError(t,n);this.wantSubscribe&&(this.subscribed=!0),this.ingestSnapshot(e,n),this._emitNothingPending()},t.prototype._handleUnsubscribe=function(t){var e=this.inflightUnsubscribe.shift();if(t)return this._emitResponseError(t,e);e&&e(),this._emitNothingPending()},t.prototype._handleOp=function(t,e){if(t)return this.inflightOp?(t.code===l.ERR_OP_SUBMIT_REJECTED&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&e.src===this.inflightOp.src&&e.seq===this.inflightOp.seq)this._opAcknowledged(e);else if(null==this.version||e.v>this.version)this.fetch();else if(!(e.v<this.version)){if(this.inflightOp)if(n=p(this.inflightOp,e))return this._hardRollback(n);for(var n,i=0;i<this.pendingOps.length;i++)if(n=p(this.pendingOps[i],e))return this._hardRollback(n);this.version++;try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}}},t.prototype._onConnectionStateChanged=function(){var t;this.connection.canSend?(this.flush(),this._resubscribe()):(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,(this.inflightFetch.length||this.inflightSubscribe.length)&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe),this.inflightFetch.length=0,this.inflightSubscribe.length=0),this.inflightUnsubscribe.length&&(t=this.inflightUnsubscribe,this.inflightUnsubscribe=[],o(t)))},t.prototype._resubscribe=function(){var e=this.pendingFetch;if(this.pendingFetch=[],this.wantSubscribe)return e.length?void this.subscribe(function(t){o(e,t)}):void this.subscribe();e.length&&this.fetch(function(t){o(e,t)})},t.prototype.fetch=function(t){var e;this.connection.canSend?(e=this.connection.sendFetch(this),n(this.inflightFetch,e,t)):this.pendingFetch.push(t)},t.prototype.subscribe=function(t){var e;this.wantSubscribe=!0,this.connection.canSend?(e=this.connection.sendSubscribe(this),n(this.inflightSubscribe,e,t)):this.pendingFetch.push(t)},t.prototype.unsubscribe=function(t){var e;this.wantSubscribe=!1,this.subscribed=!1,this.connection.canSend?(e=this.connection.sendUnsubscribe(this),n(this.inflightUnsubscribe,e,t)):t&&s.nextTick(t)},t.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},t.prototype._otApply=function(t,e){if(t.op){if(!this.type)throw new a(l.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(!e&&this.type===u.defaultType&&1<t.op.length){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<t.op.length;i++){for(var r={op:[t.op[i]]},o=n;o<this.applyStack.length;o++){var s=p(this.applyStack[o],r);if(s)return this._hardRollback(s)}this.emit("before op",r.op,e,t.src),this.data=this.type.apply(this.data,r.op),this.emit("op",r.op,e,t.src)}return void this._popApplyStack(n)}return this.emit("before op",t.op,e,t.src),this.data=this.type.apply(this.data,t.op),void this.emit("op",t.op,e,t.src)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",e);var c;t.del&&(c=this.data,this._setType(null),this.emit("del",c,e))},t.prototype._sendOp=function(){if(this.connection.canSend){var t=this.connection.id;this.inflightOp||(this.inflightOp=this.pendingOps.shift());var e=this.inflightOp;if(!e){var n=new a(l.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp");return this.emit("error",n)}if(e.sentAt=Date.now(),e.retries=null==e.retries?0:e.retries+1,null==e.seq){if(this.connection.seq>=r.MAX_SAFE_INTEGER)return this.emit("error",new a(l.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));e.seq=this.connection.seq++}this.connection.sendOp(this,e),null==e.src&&(e.src=t)}},t.prototype._submit=function(t,e,n){if(e=e||!0,t.op){if(!this.type){var i=new a(l.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return n?n(i):this.emit("error",i)}this.type.normalize&&(t.op=this.type.normalize(t.op))}try{this._pushOp(t,n),this._otApply(t,e)}catch(t){return this._hardRollback(t)}var r=this;s.nextTick(function(){r.flush()})},t.prototype._pushOp=function(t,e){if(this.applyStack)this.applyStack.push(t);else{var n=this._tryCompose(t);if(n)return void n.callbacks.push(e)}t.type=this.type,t.callbacks=[e],this.pendingOps.push(t)},t.prototype._popApplyStack=function(t){if(0<t)this.applyStack.length=t;else{var e=this.applyStack[0];if(this.applyStack=null,e)if(-1!==(i=this.pendingOps.indexOf(e)))for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){var e=n[i],r=this._tryCompose(e);r?r.callbacks=r.callbacks.concat(e.callbacks):this.pendingOps.push(e)}}},t.prototype._tryCompose=function(t){if(!this.preventCompose){var e=this.pendingOps[this.pendingOps.length-1];if(e&&!e.sentAt)return e.create&&t.op?(e.create.data=this.type.apply(e.create.data,t.op),e):e.op&&t.op&&this.type.compose?(e.op=this.type.compose(e.op,t.op),e):void 0}},t.prototype.submitOp=function(t,e,n){"function"==typeof e&&(n=e,e=null);t={op:t},e=e&&e.source;this._submit(t,e,n)},t.prototype.create=function(t,e,n,i){if("function"==typeof e?(i=e,e=n=null):"function"==typeof n&&(i=n,n=null),e=e||u.defaultType.uri,this.type){var r=new a(l.ERR_DOC_ALREADY_CREATED,"Document already exists");return i?i(r):this.emit("error",r)}t={create:{type:e,data:t}},n=n&&n.source;this._submit(t,n,i)},t.prototype.del=function(t,e){if("function"==typeof t&&(e=t,t=null),!this.type){var n=new a(l.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");return e?e(n):this.emit("error",n)}t=t&&t.source;this._submit({del:!0},t,e)},t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1,this.flush()},t.prototype._opAcknowledged=function(t){if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return e.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},t.prototype._rollback=function(t){var e=this.inflightOp;if(e.op&&e.type.invert){e.op=e.type.invert(e.op);for(var n=0;n<this.pendingOps.length;n++){var i=p(this.pendingOps[n],e);if(i)return this._hardRollback(i)}try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}this._clearInflightOp(t)}else this._hardRollback(t)},t.prototype._hardRollback=function(n){var i=[];this.inflightOp&&i.push(this.inflightOp),i=i.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var r=this;this.fetch(function(){for(var t=!!i.length,e=0;e<i.length;e++)t=o(i[e].callbacks,n)&&t;if(n&&!t)return r.emit("error",n)})},t.prototype._clearInflightOp=function(t){var e=this.inflightOp;this.inflightOp=null;e=o(e.callbacks,t);if(this.flush(),this._emitNothingPending(),t&&!e)return this.emit("error",t)}}).call(this)}).call(this,c("_process"))},{"../emitter":21,"../error":22,"../logger":23,"../types":27,"../util":28,_process:7}],10:[function(t,e,n){n.Connection=t("./connection"),n.Doc=t("./doc"),n.Error=t("../error"),n.Query=t("./query"),n.types=t("../types"),n.logger=t("../logger")},{"../error":22,"../logger":23,"../types":27,"./connection":8,"./doc":9,"./query":17}],11:[function(t,e,n){var r=t("./presence"),i=t("./local-doc-presence"),o=t("./remote-doc-presence");function s(t,e,n){var i=s.channel(e,n);r.call(this,t,i),this.collection=e,this.id=n}(e.exports=s).prototype=Object.create(r.prototype),s.channel=function(t,e){return t+"."+e},s.prototype._createLocalPresence=function(t){return new i(this,t)},s.prototype._createRemotePresence=function(t){return new o(this,t)}},{"./local-doc-presence":12,"./presence":14,"./remote-doc-presence":15}],12:[function(t,e,n){var i=t("./local-presence"),r=t("../../error").CODES;function o(t,e){i.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._isSending=!1,this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}((e.exports=o).prototype=Object.create(i.prototype)).submit=function(t,e){if(!this._doc.type){var n={code:r.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,e)}i.prototype.submit.call(this,t,e)},o.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createOrDelHandler),this._doc.removeListener("del",this._createOrDelHandler),this._doc.removeListener("load",this._loadHandler),this._doc.removeListener("destroy",this._destroyHandler),i.prototype.destroy.call(this,t)},o.prototype._sendPending=function(){var e;this._isSending||(this._isSending=!0,(e=this)._doc.whenNothingPending(function(){e._isSending=!1,e.connection.canSend&&(e._pendingMessages.forEach(function(t){t.t=e._doc.type.uri,t.v=e._doc.version,e.connection.send(t)}),e._pendingMessages=[])}))},o.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createOrDelHandler),this._doc.on("del",this._createOrDelHandler),this._doc.on("load",this._loadHandler),this._doc.on("destroy",this._destroyHandler)},o.prototype._transformAgainstOp=function(t,i){var r=this;this._pendingMessages.forEach(function(e){try{e.p=r._doc.type.transformPresence(e.p,t,i)}catch(t){var n=r._getCallback(e.pv);r._callbackOrEmit(t,n)}});try{this.value=this._doc.type.transformPresence(this.value,t,i)}catch(t){this.emit("error",t)}},o.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(t){t.p=null}),this.value=null},o.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[]},o.prototype._message=function(){var t=i.prototype._message.call(this);return t.c=this.collection,t.d=this.id,t.v=null,t.t=null,t}},{"../../error":22,"./local-presence":13}],13:[function(e,r,t){(function(i){(function(){var n=e("../../emitter");function t(t,e){if(n.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("LocalPresence presenceId must be a string");this.presence=t,this.presenceId=e,this.connection=t.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}r.exports=t,n.mixin(t),t.prototype.submit=function(t,e){this.value=t,this.send(e)},t.prototype.send=function(t){var e=this._message();this._pendingMessages.push(e),this._callbacksByPresenceVersion[e.pv]=t,this._sendPending()},t.prototype.destroy=function(e){var n=this;this.submit(null,function(t){return t?n._callbackOrEmit(t,e):(delete n.presence.localPresences[n.presenceId],void(e&&e()))})},t.prototype._sendPending=function(){var e;this.connection.canSend&&((e=this)._pendingMessages.forEach(function(t){e.connection.send(t)}),this._pendingMessages=[])},t.prototype._ack=function(t,e){e=this._getCallback(e);this._callbackOrEmit(t,e)},t.prototype._message=function(){return{a:"p",ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}},t.prototype._getCallback=function(t){var e=this._callbacksByPresenceVersion[t];return delete this._callbacksByPresenceVersion[t],e},t.prototype._callbackOrEmit=function(t,e){if(e)return i.nextTick(e,t);t&&this.emit("error",t)}}).call(this)}).call(this,e("_process"))},{"../../emitter":21,_process:7}],14:[function(a,u,t){(function(c){(function(){var n=a("../../emitter"),e=a("./local-presence"),i=a("./remote-presence"),r=a("../../util"),o=a("async"),s=a("hat");function t(t,e){if(n.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("Presence channel must be provided");this.connection=t,this.channel=e,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this.seq=1,this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={}}u.exports=t,n.mixin(t),t.prototype.subscribe=function(t){this._sendSubscriptionAction(!0,t)},t.prototype.unsubscribe=function(t){this._sendSubscriptionAction(!1,t)},t.prototype.create=function(t){t=t||s();var e=this._createLocalPresence(t);return this.localPresences[t]=e},t.prototype.destroy=function(i){var r=this;this.unsubscribe(function(t){if(t)return r._callbackOrEmit(t,i);var e=Object.keys(r.localPresences),n=Object.keys(r._remotePresenceInstances);o.parallel([function(t){o.each(e,function(t,e){r.localPresences[t].destroy(e)},t)},function(t){o.each(n,function(t,e){r._remotePresenceInstances[t].destroy(e)},t)}],function(t){delete r.connection._presences[r.channel],r._callbackOrEmit(t,i)})})},t.prototype._sendSubscriptionAction=function(t,e){this.wantSubscribe=!!t;var n=this.wantSubscribe?"ps":"pu",t=this.seq++;this._subscriptionCallbacksBySeq[t]=e,this.connection.canSend&&this.connection._sendPresenceAction(n,t,this)},t.prototype._handleSubscribe=function(t,e){this.wantSubscribe&&(this.subscribed=!0);e=this._subscriptionCallback(e);this._callbackOrEmit(t,e)},t.prototype._handleUnsubscribe=function(t,e){this.subscribed=!1;e=this._subscriptionCallback(e);this._callbackOrEmit(t,e)},t.prototype._receiveUpdate=function(t,e){var n=r.dig(this.localPresences,e.id);if(n)return n._ack(t,e.pv);if(t)return this.emit("error",t);var i=this;r.digOrCreate(this._remotePresenceInstances,e.id,function(){return i._createRemotePresence(e.id)}).receiveUpdate(e)},t.prototype._updateRemotePresence=function(t){this.remotePresences[t.presenceId]=t.value,null===t.value&&this._removeRemotePresence(t.presenceId),this.emit("receive",t.presenceId,t.value)},t.prototype._broadcastAllLocalPresence=function(t){if(t)return this.emit("error",t);for(var e in this.localPresences){var n=this.localPresences[e];null!==n.value&&n.send()}},t.prototype._removeRemotePresence=function(t){this._remotePresenceInstances[t].destroy(),delete this._remotePresenceInstances[t],delete this.remotePresences[t]},t.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)for(var t in this._resubscribe(),this.localPresences)this.localPresences[t]._sendPending()},t.prototype._resubscribe=function(){var t,e=[];for(t in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(t);e.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(null,e);var i=this;this.subscribe(function(t){i._callEachOrEmit(t,e)})},t.prototype._subscriptionCallback=function(t){var e=this._subscriptionCallbacksBySeq[t];return delete this._subscriptionCallbacksBySeq[t],e},t.prototype._callbackOrEmit=function(t,e){if(e)return c.nextTick(e,t);t&&this.emit("error",t)},t.prototype._createLocalPresence=function(t){return new e(this,t)},t.prototype._createRemotePresence=function(t){return new i(this,t)},t.prototype._callEachOrEmit=function(e,t){if(t&&t.length)return t.forEach(function(t){c.nextTick(t,e)});e&&this.emit("error",e)}}).call(this)}).call(this,a("_process"))},{"../../emitter":21,"../../util":28,"./local-presence":13,"./remote-presence":16,_process:7,async:29,hat:2}],15:[function(t,e,n){var i=t("./remote-presence"),r=t("../../ot");function o(t,e){i.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}((e.exports=o).prototype=Object.create(i.prototype)).receiveUpdate=function(t){this._pending&&t.pv<this._pending.pv||(this.src=t.src,this._pending=t,this._setPendingPresence())},o.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createDelHandler),this._doc.removeListener("del",this._createDelHandler),this._doc.removeListener("load",this._loadHandler),i.prototype.destroy.call(this,t)},o.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createDelHandler),this._doc.on("del",this._createDelHandler),this._doc.on("load",this._loadHandler)},o.prototype._setPendingPresence=function(){var t;this._pendingSetPending||(this._pendingSetPending=!0,(t=this)._doc.whenNothingPending(function(){if(t._pendingSetPending=!1,t._pending)return t._pending.pv<t.presenceVersion?t._pending=null:t._pending.v>t._doc.version?t._doc.fetch():void(t._catchUpStalePresence()&&(t.value=t._pending.p,t.presenceVersion=t._pending.pv,t._pending=null,t.presence._updateRemotePresence(t)))}))},o.prototype._handleOp=function(t,e,n){n=n===this.src;this._transformAgainstOp(t,n),this._cacheOp(t,n),this._setPendingPresence()},i.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()},i.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)},o.prototype._transformAgainstOp=function(t,e){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,t,e)}catch(t){return this.presence.emit("error",t)}this.presence._updateRemotePresence(this)}},o.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var t=this._opCache[this._pending.v],e=t.op,t=t.isOwnOp;null===e?(this._pending.p=null,this._pending.v++):r.transformPresence(this._pending,e,t)}var n=this._pending.v>=this._doc.version;return n&&this._stopCachingOps(),n},o.prototype._startCachingOps=function(){this._opCache=[]},o.prototype._stopCachingOps=function(){this._opCache=null},o.prototype._cacheOp=function(t,e){this._opCache&&(t=t?{op:t}:null,this._opCache[this._doc.version-1]={op:t,isOwnOp:e})}},{"../../ot":25,"./remote-presence":16}],16:[function(t,n,e){(function(e){(function(){function t(t,e){this.presence=t,this.presenceId=e,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}(n.exports=t).prototype.receiveUpdate=function(t){t.pv<this.presenceVersion||(this.value=t.p,this.presenceVersion=t.pv,this.presence._updateRemotePresence(this))},t.prototype.destroy=function(t){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],t&&e.nextTick(t)}}).call(this)}).call(this,t("_process"))},{_process:7}],17:[function(n,i,t){(function(e){(function(){var c=n("../emitter");function t(t,e,n,i,r,o,s){c.EventEmitter.call(this),this.action=t,this.connection=e,this.id=n,this.collection=i,this.query=r,this.results=null,o&&o.results&&(this.results=o.results,delete o.results),this.extra=void 0,this.options=o,this.callback=s,this.ready=!1,this.sent=!1}i.exports=t,c.mixin(t),t.prototype.hasPending=function(){return!this.ready},t.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],n=0;n<this.results.length;n++){var i=this.results[n];e.push([i.id,i.version])}t.r=e}this.connection.send(t),this.sent=!0}},t.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&e.nextTick(t)},t.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},t.prototype._handleFetch=function(t,e,n){this.connection._destroyQuery(this),this._handleResponse(t,e,n)},t.prototype._handleSubscribe=function(t,e,n){this._handleResponse(t,e,n)},t.prototype._handleResponse=function(t,e,n){var i=this.callback;if(this.callback=null,t)return this._finishResponse(t,i);if(!e)return this._finishResponse(null,i);function r(t){if(t)return o._finishResponse(t,i);--s||o._finishResponse(null,i)}var o=this,s=1;if(Array.isArray(e))s+=e.length,this.results=this._ingestSnapshots(e,r),this.extra=n;else for(var c in e){s++;var a=e[c];this.connection.get(a.c||this.collection,c).ingestSnapshot(a,r)}r()},t.prototype._ingestSnapshots=function(t,e){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=this.connection.get(r.c||this.collection,r.d);o.ingestSnapshot(r,e),n.push(o)}return n},t.prototype._finishResponse=function(t,e){if(this.emit("ready"),this.ready=!0,t)return this.connection._destroyQuery(this),e?e(t):this.emit("error",t);e&&e(null,this.results,this.extra)},t.prototype._handleError=function(t){this.emit("error",t)},t.prototype._handleDiff=function(t){for(var e=0;e<t.length;e++)"insert"===(n=t[e]).type&&(n.values=this._ingestSnapshots(n.values));for(var n,e=0;e<t.length;e++)switch((n=t[e]).type){case"insert":var i=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(i)),this.emit("insert",i,n.index);break;case"remove":var r=n.howMany||1,o=this.results.splice(n.index,r);this.emit("remove",o,n.index);break;case"move":r=n.howMany||1,o=this.results.splice(n.from,r);Array.prototype.splice.apply(this.results,[n.to,0].concat(o)),this.emit("move",o,n.from,n.to)}this.emit("changed",this.results)},t.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)}}).call(this)}).call(this,n("_process"))},{"../emitter":21,_process:7}],18:[function(t,e,n){var i=t("../../snapshot"),o=t("../../emitter");function r(t,e,n,i,r){if(o.EventEmitter.call(this),"function"!=typeof r)throw new Error("Callback is required for SnapshotRequest");this.requestId=e,this.connection=t,this.id=i,this.collection=n,this.callback=r,this.sent=!1}e.exports=r,o.mixin(r),r.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},r.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},r.prototype._handleResponse=function(t,e){if(this.emit("ready"),t)return this.callback(t);t=e.meta||null,t=new i(this.id,e.v,e.type,e.data,t);this.callback(null,t)}},{"../../emitter":21,"../../snapshot":26}],19:[function(t,e,n){var s=t("./snapshot-request"),c=t("../../util");function i(t,e,n,i,r,o){if(s.call(this,t,e,n,i,o),!c.isValidTimestamp(r))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=r}((e.exports=i).prototype=Object.create(s.prototype))._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}}},{"../../util":28,"./snapshot-request":18}],20:[function(t,e,n){var s=t("./snapshot-request"),c=t("../../util");function i(t,e,n,i,r,o){if(s.call(this,t,e,n,i,o),!c.isValidVersion(r))throw new Error("Snapshot version must be a positive integer or null");this.version=r}((e.exports=i).prototype=Object.create(s.prototype))._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}}},{"../../util":28,"./snapshot-request":18}],21:[function(t,e,n){var i=t("events").EventEmitter;n.EventEmitter=i,n.mixin=function(t){for(var e in i.prototype)t.prototype[e]=i.prototype[e]}},{events:1}],22:[function(t,e,n){function i(t,e){this.code=t,this.message=e||"",Error.captureStackTrace?Error.captureStackTrace(this,i):this.stack=(new Error).stack}((i.prototype=Object.create(Error.prototype)).constructor=i).prototype.name="ShareDBError",i.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"},e.exports=i},{}],23:[function(t,e,n){t=new(t("./logger"));e.exports=t},{"./logger":24}],24:[function(t,e,n){var i=["info","warn","error"];function r(){var e={};i.forEach(function(t){e[t]=console[t].bind(console)}),this.setMethods(e)}(e.exports=r).prototype.setMethods=function(e){e=e||{};var n=this;i.forEach(function(t){"function"==typeof e[t]&&(n[t]=e[t])})}},{}],25:[function(t,e,n){var o=t("./types").map,s=t("./error"),c=t("./util"),a=s.CODES;n.checkOp=function(t){if(null==t||"object"!=typeof t)return new s(a.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(null!=t.create){if("object"!=typeof t.create)return new s(a.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var e=t.create.type;if("string"!=typeof e)return new s(a.ERR_OT_OP_BADLY_FORMED,"Missing create type");e=o[e];if(null==e||"object"!=typeof e)return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(null!=t.del){if(!0!==t.del)return new s(a.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(null==t.op)return new s(a.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");return null!=t.src&&"string"!=typeof t.src?new s(a.ERR_OT_OP_BADLY_FORMED,"src must be a string"):null!=t.seq&&"number"!=typeof t.seq?new s(a.ERR_OT_OP_BADLY_FORMED,"seq must be a string"):null==t.src&&null!=t.seq||null!=t.src&&null==t.seq?new s(a.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together"):null!=t.m&&"object"!=typeof t.m?new s(a.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null"):void 0},n.normalizeType=function(t){return o[t]&&o[t].uri},n.apply=function(t,e){if("object"!=typeof t)return new s(a.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(null!=t.v&&null!=e.v&&t.v!==e.v)return new s(a.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(e.create){if(t.type)return new s(a.ERR_DOC_ALREADY_CREATED,"Document already exists");var n=e.create,i=o[n.type];if(!i)return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=i.create(n.data),t.type=i.uri,t.v++}catch(r){return r}}else if(e.del)t.data=void 0,t.type=null,t.v++;else if(e.op){var r=function(t,e){if(!t.type)return new s(a.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(null==e)return new s(a.ERR_OT_OP_NOT_PROVIDED,"Missing op");var n=o[t.type];if(!n)return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=n.apply(t.data,e)}catch(t){return t}}(t,e.op);if(r)return r;t.v++}else t.v++},n.transform=function(t,e,n){if(null!=e.v&&e.v!==n.v)return new s(a.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(n.del){if(e.create||e.op)return new s(a.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(n.create&&(e.op||e.create||e.del)||n.op&&e.create)return new s(a.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if(n.op&&e.op){if(!t)return new s(a.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if("string"==typeof t&&!(t=o[t]))return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.op=t.transform(e.op,n.op,"left")}catch(t){return t}}}null!=e.v&&e.v++},n.applyOps=function(t,e){var n=null;if(t.type&&!(n=o[t.type]))return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");for(var i=0;i<e.length;i++){var r=e[i];if(t.v=r.v+1,r.create){if(!(n=o[r.create.type]))return new s(a.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");t.data=n.create(r.create.data),t.type=n.uri}else r.del?(t.data=void 0,n=null,t.type=null):t.data=n.apply(t.data,r.op)}},n.transformPresence=function(t,e,n){var i=this.checkOp(e);if(i)return i;var r=t.t;if("string"==typeof r&&(r=o[r]),!r)return{code:a.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!c.supportsPresence(r))return{code:a.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(e.create||e.del)return t.p=null,void t.v++;try{t.p=null===t.p?null:r.transformPresence(t.p,e.op,n)}catch(t){return{code:a.ERR_PRESENCE_TRANSFORM_FAILED,message:t.message||t}}t.v++}},{"./error":22,"./types":27,"./util":28}],26:[function(t,e,n){e.exports=function(t,e,n,i,r){this.id=t,this.v=e,this.type=n,this.data=i,this.m=r}},{}],27:[function(t,e,n){n.defaultType=t("ot-json0").type,n.map={},n.register=function(t){t.name&&(n.map[t.name]=t),t.uri&&(n.map[t.uri]=t)},n.register(n.defaultType)},{"ot-json0":4}],28:[function(t,e,s){s.doNothing=function(){},s.hasKeys=function(t){for(var e in t)return!0;return!1},s.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},s.isValidVersion=function(t){return null===t||s.isInteger(t)&&0<=t},s.isValidTimestamp=function(t){return s.isValidVersion(t)},s.MAX_SAFE_INTEGER=9007199254740991,s.dig=function(){for(var t=arguments[0],e=1;e<arguments.length;e++)t=t[arguments[e]]||(e===arguments.length-1?void 0:{});return t},s.digOrCreate=function(){for(var t=arguments[0],e=arguments[arguments.length-1],n=1;n<arguments.length-1;n++)var i=arguments[n],t=t[i]||(t[i]=n===arguments.length-2?e():{});return t},s.digAndRemove=function(){for(var t=arguments[0],e=[t],n=1;n<arguments.length-1;n++){var i=arguments[n];if(!t.hasOwnProperty(i))break;t=t[i],e.push(t)}for(n=e.length-1;0<=n;n--){var r=e[n],o=r[i=arguments[n+1]];n!==e.length-1&&s.hasKeys(o)||delete r[i]}},s.supportsPresence=function(t){return t&&"function"==typeof t.transformPresence}},{}],29:[function(t,Sn,n){(function(On,Rn,bn){(function(){var t,e;t=this,e=function(t){"use strict";function v(t,e){e|=0;for(var n=Math.max(t.length-e,0),i=Array(n),r=0;r<n;r++)i[r]=t[e+r];return i}function e(e){var n=v(arguments,1);return function(){var t=v(arguments);return e.apply(null,n.concat(t))}}var a=function(n){return function(){var t=v(arguments),e=t.pop();n.call(this,t,e)}};function r(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var n="function"==typeof bn&&bn,i="object"==typeof On&&"function"==typeof On.nextTick;function o(t){setTimeout(t,0)}function s(n){return function(t){var e=v(arguments,1);n(function(){t.apply(null,e)})}}var h=s(n?bn:i?On.nextTick:o);function c(i){return a(function(t,e){var n;try{n=i.apply(this,t)}catch(t){return e(t)}r(n)&&"function"==typeof n.then?n.then(function(t){u(e,null,t)},function(t){u(e,t.message?t:new Error(t))}):e(null,n)})}function u(t,e,n){try{t(e,n)}catch(t){h(l,t)}}function l(t){throw t}var p="function"==typeof Symbol;function f(t){return p&&"AsyncFunction"===t[Symbol.toStringTag]}function y(t){return f(t)?c(t):t}function d(r){return function(e){var t=v(arguments,1),n=a(function(n,t){var i=this;return r(e,function(t,e){y(t).apply(i,n.concat(e))},t)});return t.length?n.apply(this,t):n}}var _="object"==typeof Rn&&Rn&&Rn.Object===Object&&Rn,g="object"==typeof self&&self&&self.Object===Object&&self,m=_||g||Function("return this")(),E=m.Symbol,O=Object.prototype,R=O.hasOwnProperty,b=O.toString,S=E?E.toStringTag:void 0;var T=Object.prototype.toString;var P="[object Null]",D="[object Undefined]",w=E?E.toStringTag:void 0;function N(t){return null==t?void 0===t?D:P:w&&w in Object(t)?function(t){var e=R.call(t,S),n=t[S];try{var i=!(t[S]=void 0)}catch(t){}var r=b.call(t);return i&&(e?t[S]=n:delete t[S]),r}(t):(t=t,T.call(t))}var A="[object AsyncFunction]",I="[object Function]",k="[object GeneratorFunction]",C="[object Proxy]";var L=9007199254740991;function x(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=L}function M(t){return null!=t&&x(t.length)&&!function(t){if(r(t)){t=N(t);return t==I||t==k||t==A||t==C}}(t)}var j={};function F(){}function q(e){return function(){var t;null!==e&&(t=e,e=null,t.apply(this,arguments))}}var U="function"==typeof Symbol&&Symbol.iterator,B=function(t){return U&&t[U]&&t[U]()};function V(t){return null!=t&&"object"==typeof t}function H(t){return V(t)&&"[object Arguments]"==N(t)}var Y=Object.prototype,G=Y.hasOwnProperty,W=Y.propertyIsEnumerable,z=H(function(){return arguments}())?H:function(t){return V(t)&&G.call(t,"callee")&&!W.call(t,"callee")},Q=Array.isArray;var J="object"==typeof t&&t&&!t.nodeType&&t,X=J&&"object"==typeof Sn&&Sn&&!Sn.nodeType&&Sn,Z=X&&X.exports===J?m.Buffer:void 0,K=(Z?Z.isBuffer:void 0)||function(){return!1},$=9007199254740991,tt=/^(?:0|[1-9]\d*)$/;var et={};et["[object Float32Array]"]=et["[object Float64Array]"]=et["[object Int8Array]"]=et["[object Int16Array]"]=et["[object Int32Array]"]=et["[object Uint8Array]"]=et["[object Uint8ClampedArray]"]=et["[object Uint16Array]"]=et["[object Uint32Array]"]=!0,et["[object Arguments]"]=et["[object Array]"]=et["[object ArrayBuffer]"]=et["[object Boolean]"]=et["[object DataView]"]=et["[object Date]"]=et["[object Error]"]=et["[object Function]"]=et["[object Map]"]=et["[object Number]"]=et["[object Object]"]=et["[object RegExp]"]=et["[object Set]"]=et["[object String]"]=et["[object WeakMap]"]=!1;var nt,it="object"==typeof t&&t&&!t.nodeType&&t,rt=it&&"object"==typeof Sn&&Sn&&!Sn.nodeType&&Sn,ot=rt&&rt.exports===it&&_.process,st=function(){try{var t=rt&&rt.require&&rt.require("util").types;return t?t:ot&&ot.binding&&ot.binding("util")}catch(t){}}(),ct=st&&st.isTypedArray,at=ct?(nt=ct,function(t){return nt(t)}):function(t){return V(t)&&x(t.length)&&!!et[N(t)]},ut=Object.prototype.hasOwnProperty;function lt(t,e){var n,i,r,o,s=Q(t),c=!s&&z(t),a=!s&&!c&&K(t),u=!s&&!c&&!a&&at(t),l=s||c||a||u,p=l?function(t,e){for(var n=-1,i=Array(t);++n<t;)i[n]=e(n);return i}(t.length,String):[],h=p.length;for(n in t)!e&&!ut.call(t,n)||l&&("length"==n||a&&("offset"==n||"parent"==n)||u&&("buffer"==n||"byteLength"==n||"byteOffset"==n)||(o=void 0,o=typeof(i=n),(r=null==(r=h)?$:r)&&("number"==o||"symbol"!=o&&tt.test(i))&&-1<i&&i%1==0&&i<r))||p.push(n);return p}var pt=Object.prototype;var ht,ft,dt=(ht=Object.keys,ft=Object,function(t){return ht(ft(t))}),_t=Object.prototype.hasOwnProperty;function vt(t){if(n=(e=t)&&e.constructor,e!==("function"==typeof n&&n.prototype||pt))return dt(t);var e,n,i,r=[];for(i in Object(t))_t.call(t,i)&&"constructor"!=i&&r.push(i);return r}function yt(t){return(M(t)?lt:vt)(t)}function gt(t){if(M(t))return n=-1,i=(e=t).length,function(){return++n<i?{value:e[n],key:n}:null};var e,n,i,r,o,s,c,a,u,l=B(t);return l?(a=l,u=-1,function(){var t=a.next();return t.done?null:(u++,{value:t.value,key:u})}):(o=yt(r=t),s=-1,c=o.length,function(){var t=o[++s];return s<c?{value:r[t],key:t}:null})}function mt(e){return function(){if(null===e)throw new Error("Callback was already called.");var t=e;e=null,t.apply(this,arguments)}}function Et(u){return function(t,e,n){if(n=q(n||F),u<=0||!t)return n(null);var i=gt(t),r=!1,o=0,s=!1;function c(t,e){if(--o,t)r=!0,n(t);else{if(e===j||r&&o<=0)return r=!0,n(null);s||a()}}function a(){for(s=!0;o<u&&!r;){var t=i();if(null===t)return r=!0,void(o<=0&&n(null));o+=1,e(t.value,t.key,mt(c))}s=!1}a()}}function Ot(t,e,n,i){Et(e)(t,y(n),i)}function Rt(i,r){return function(t,e,n){return i(t,r,e,n)}}function bt(t,e,n){n=q(n||F);var i=0,r=0,o=t.length;function s(t,e){t?n(t):++r!==o&&e!==j||n(null)}for(0===o&&n(null);i<o;i++)e(t[i],i,mt(s))}function St(t,e,n){(M(t)?bt:Tt)(t,y(e),n)}var Tt=Rt(Ot,1/0);function Pt(i){return function(t,e,n){return i(St,t,y(e),n)}}function Dt(t,e,n,i){i=i||F,e=e||[];var r=[],o=0,s=y(n);t(e,function(t,e,n){var i=o++;s(t,function(t,e){r[i]=e,n(t)})},function(t){i(t,r)})}var wt=Pt(Dt),Nt=d(wt);function At(r){return function(t,e,n,i){return r(Et(e),t,y(n),i)}}var It=At(Dt),kt=Rt(It,1),Ct=d(kt);function Lt(t,e){for(var n=-1,i=null==t?0:t.length;++n<i&&!1!==e(t[n],n,t););return t}var xt,Mt=function(t,e,n){for(var i=-1,r=Object(t),o=n(t),s=o.length;s--;){var c=o[xt?s:++i];if(!1===e(r[c],c,r))break}return t};function jt(t,e){return t&&Mt(t,e,yt)}function Ft(t){return t!=t}function qt(t,e,n){return e==e?function(t,e,n){for(var i=n-1,r=t.length;++i<r;)if(t[i]===e)return i;return-1}(t,e,n):function(t,e,n,i){for(var r=t.length,o=n+(i?1:-1);i?o--:++o<r;)if(e(t[o],o,t))return o;return-1}(t,Ft,n)}function Ut(s,t,c){"function"==typeof t&&(c=t,t=null),c=q(c||F);var n=yt(s).length;if(!n)return c(null);t=t||n;var a={},u=0,l=!1,p=Object.create(null),e=[],h=[],f={};function d(r,o){e.push(function(){var i,t,e,n;i=r,t=o,l||(e=mt(function(t,e){var n;u--,2<arguments.length&&(e=v(arguments,1)),t?(n={},jt(a,function(t,e){n[e]=t}),n[i]=e,l=!0,p=Object.create(null),c(t,n)):(a[i]=e,Lt(p[i]||[],function(t){t()}),_())}),u++,n=y(t[t.length-1]),1<t.length?n(a,e):n(e))})}function _(){if(0===e.length&&0===u)return c(null,a);for(;e.length&&u<t;)e.shift()()}jt(s,function(n,i){if(!Q(n))return d(i,[n]),void h.push(i);var r=n.slice(0,n.length-1),o=r.length;if(0===o)return d(i,n),void h.push(i);f[i]=o,Lt(r,function(t){if(!s[t])throw new Error("async.auto task `"+i+"` has a non-existent dependency `"+t+"` in "+r.join(", "));var e;e=function(){0===--o&&d(i,n)},(p[t=t]||(p[t]=[])).push(e)})}),function(){for(var t,e=0;h.length;)t=h.pop(),e++,Lt(function(n){var i=[];return jt(s,function(t,e){Q(t)&&0<=qt(t,n,0)&&i.push(e)}),i}(t),function(t){0==--f[t]&&h.push(t)});if(e!==n)throw new Error("async.auto cannot execute tasks due to a recursive dependency")}(),_()}function Bt(t,e){for(var n=-1,i=null==t?0:t.length,r=Array(i);++n<i;)r[n]=e(t[n],n,t);return r}var Vt="[object Symbol]";var Ht=1/0,Yt=E?E.prototype:void 0,Gt=Yt?Yt.toString:void 0;function Wt(t){if("string"==typeof t)return t;if(Q(t))return Bt(t,Wt)+"";if("symbol"==typeof(e=t)||V(e)&&N(e)==Vt)return Gt?Gt.call(t):"";var e=t+"";return"0"==e&&1/t==-Ht?"-0":e}function zt(t,e,n){var i=t.length;return n=void 0===n?i:n,!e&&i<=n?t:function(t,e,n){var i=-1,r=t.length;e<0&&(e=r<-e?0:r+e),(n=r<n?r:n)<0&&(n+=r),r=n<e?0:n-e>>>0,e>>>=0;for(var o=Array(r);++i<r;)o[i]=t[i+e];return o}(t,e,n)}var Qt=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var Jt="\\ud800-\\udfff",Xt="["+Jt+"]",Zt="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Kt="\\ud83c[\\udffb-\\udfff]",$t="[^"+Jt+"]",te="(?:\\ud83c[\\udde6-\\uddff]){2}",ee="[\\ud800-\\udbff][\\udc00-\\udfff]",ne="(?:"+Zt+"|"+Kt+")"+"?",ie="[\\ufe0e\\ufe0f]?",re=ie+ne+("(?:\\u200d(?:"+[$t,te,ee].join("|")+")"+ie+ne+")*"),oe="(?:"+[$t+Zt+"?",Zt,te,ee,Xt].join("|")+")",se=RegExp(Kt+"(?="+Kt+")|"+oe+re,"g");function ce(t){return e=t,Qt.test(e)?t.match(se)||[]:t.split("");var e}var ae=/^\s+|\s+$/g;function ue(t,e,n){var i;if((t=null==(i=t)?"":Wt(i))&&(n||void 0===e))return t.replace(ae,"");if(!t||!(e=Wt(e)))return t;t=ce(t),e=ce(e);return zt(t,function(t,e){for(var n=-1,i=t.length;++n<i&&-1<qt(e,t[n],0););return n}(t,e),function(t,e){for(var n=t.length;n--&&-1<qt(e,t[n],0););return n}(t,e)+1).join("")}var le=/^(?:async\s+)?(function)?\s*[^\(]*\(\s*([^\)]*)\)/m,pe=/,/,he=/(=.+)?(\s*)$/,fe=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;function de(t,e){var s={};jt(t,function(i,t){var r,e=f(i),n=!e&&1===i.length||e&&0===i.length;if(Q(i))r=i.slice(0,-1),i=i[i.length-1],s[t]=r.concat(0<r.length?o:i);else if(n)s[t]=i;else{if(r=n=(n=(n=(n=(n=i).toString().replace(fe,"")).match(le)[2].replace(" ",""))?n.split(pe):[]).map(function(t){return ue(t.replace(he,""))}),0===i.length&&!e&&0===r.length)throw new Error("autoInject task functions require explicit parameters.");e||r.pop(),s[t]=r.concat(o)}function o(e,t){var n=Bt(r,function(t){return e[t]});n.push(t),y(i).apply(null,n)}}),Ut(s,e)}function _e(){this.head=this.tail=null,this.length=0}function ve(t,e){t.length=1,t.head=t.tail=e}function ye(t,e,n){if(null==e)e=1;else if(0===e)throw new Error("Concurrency must not be zero");var s=y(t),c=0,a=[],u=!1;function i(t,e,n){if(null!=n&&"function"!=typeof n)throw new Error("task callback must be a function");if(p.started=!0,Q(t)||(t=[t]),0===t.length&&p.idle())return h(function(){p.drain()});for(var i=0,r=t.length;i<r;i++){var o={data:t[i],callback:n||F};e?p._tasks.unshift(o):p._tasks.push(o)}u||(u=!0,h(function(){u=!1,p.process()}))}var l=!1,p={_tasks:new _e,concurrency:e,payload:n,saturated:F,unsaturated:F,buffer:e/4,empty:F,drain:F,error:F,started:!1,paused:!1,push:function(t,e){i(t,!1,e)},kill:function(){p.drain=F,p._tasks.empty()},unshift:function(t,e){i(t,!0,e)},remove:function(t){p._tasks.remove(t)},process:function(){if(!l){for(l=!0;!p.paused&&c<p.concurrency&&p._tasks.length;){var t=[],e=[],n=p._tasks.length;p.payload&&(n=Math.min(n,p.payload));for(var i=0;i<n;i++){var r=p._tasks.shift();t.push(r),a.push(r),e.push(r.data)}c+=1,0===p._tasks.length&&p.empty(),c===p.concurrency&&p.saturated();var o=mt(function(o){return function(t){--c;for(var e=0,n=o.length;e<n;e++){var i=o[e],r=qt(a,i,0);0===r?a.shift():0<r&&a.splice(r,1),i.callback.apply(i,arguments),null!=t&&p.error(t,i.data)}c<=p.concurrency-p.buffer&&p.unsaturated(),p.idle()&&p.drain(),p.process()}}(t));s(e,o)}l=!1}},length:function(){return p._tasks.length},running:function(){return c},workersList:function(){return a},idle:function(){return p._tasks.length+c===0},pause:function(){p.paused=!0},resume:function(){!1!==p.paused&&(p.paused=!1,h(p.process))}};return p}function ge(t,e){return ye(t,1,e)}_e.prototype.removeLink=function(t){return t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,t.prev=t.next=null,--this.length,t},_e.prototype.empty=function(){for(;this.head;)this.shift();return this},_e.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,t.next?t.next.prev=e:this.tail=e,t.next=e,this.length+=1},_e.prototype.insertBefore=function(t,e){e.prev=t.prev,(e.next=t).prev?t.prev.next=e:this.head=e,t.prev=e,this.length+=1},_e.prototype.unshift=function(t){this.head?this.insertBefore(this.head,t):ve(this,t)},_e.prototype.push=function(t){this.tail?this.insertAfter(this.tail,t):ve(this,t)},_e.prototype.shift=function(){return this.head&&this.removeLink(this.head)},_e.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},_e.prototype.toArray=function(){for(var t=Array(this.length),e=this.head,n=0;n<this.length;n++)t[n]=e.data,e=e.next;return t},_e.prototype.remove=function(t){for(var e=this.head;e;){var n=e.next;t(e)&&this.removeLink(e),e=n}return this};var me=Rt(Ot,1);function Ee(t,i,e,n){n=q(n||F);var r=y(e);me(t,function(t,e,n){r(i,t,function(t,e){i=e,n(t)})},function(t){n(t,i)})}function Oe(){var e=Bt(arguments,y);return function(){var t=v(arguments),i=this,n=t[t.length-1];"function"==typeof n?t.pop():n=F,Ee(e,t,function(t,e,n){e.apply(i,t.concat(function(t){var e=v(arguments,1);n(t,e)}))},function(t,e){n.apply(i,[t].concat(e))})}}function Re(){return Oe.apply(null,v(arguments).reverse())}function be(t,e,n,r){r=r||F;var i=y(n);It(t,e,function(t,e){i(t,function(t){return t?e(t):e(null,v(arguments,1))})},function(t,e){for(var n=[],i=0;i<e.length;i++)e[i]&&(n=Te.apply(n,e[i]));return r(t,n)})}function Se(){var t=v(arguments),e=[null].concat(t);return function(){return arguments[arguments.length-1].apply(this,e)}}var Te=Array.prototype.concat,Pe=Rt(be,1/0),De=Rt(be,1);function we(t){return t}function Ne(c,a){return function(t,e,r,n){n=n||F;var o,s=!1;t(e,function(n,t,i){r(n,function(t,e){t?i(t):c(e)&&!o?(o=a(s=!0,n),i(null,j)):i()})},function(t){t?n(t):n(null,s?o:a(!1))})}}function Ae(t,e){return e}var Ie=Pt(Ne(we,Ae)),ke=At(Ne(we,Ae)),Ce=Rt(ke,1);function Le(n){return function(t){var e=v(arguments,1);e.push(function(t){var e=v(arguments,1);"object"==typeof console&&(t?console.error&&console.error(t):console[n]&&Lt(e,function(t){console[n](t)}))}),y(t).apply(null,e)}}g=Le("dir");function xe(t,e,n){n=mt(n||F);var i=y(t),r=y(e);function o(t){if(t)return n(t);t=v(arguments,1);t.push(s),r.apply(this,t)}function s(t,e){return t?n(t):e?void i(o):n(null)}s(null,!0)}function Me(t,e,n){n=mt(n||F);var i=y(t),r=function(t){if(t)return n(t);t=v(arguments,1);if(e.apply(this,t))return i(r);n.apply(null,[null].concat(t))};i(r)}function je(t,e,n){Me(t,function(){return!e.apply(this,arguments)},n)}function Fe(t,e,n){n=mt(n||F);var i=y(e),r=y(t);function o(t){if(t)return n(t);r(s)}function s(t,e){return t?n(t):e?void i(o):n(null)}r(s)}function qe(i){return function(t,e,n){return i(t,n)}}function Ue(t,e,n){St(t,qe(y(e)),n)}function Be(t,e,n,i){Et(e)(t,qe(y(n)),i)}var Ve=Rt(Be,1);function He(i){return f(i)?i:a(function(t,e){var n=!0;t.push(function(){var t=arguments;n?h(function(){e.apply(null,t)}):e.apply(null,t)}),i.apply(this,t),n=!1})}function Ye(t){return!t}O=Pt(Ne(Ye,Ye)),Y=At(Ne(Ye,Ye)),X=Rt(Y,1);function Ge(e){return function(t){return null==t?void 0:t[e]}}function We(t,i,e,r){var o=new Array(i.length);t(i,function(t,n,i){e(t,function(t,e){o[n]=!!e,i(t)})},function(t){if(t)return r(t);for(var e=[],n=0;n<i.length;n++)o[n]&&e.push(i[n]);r(null,e)})}function ze(t,e,o,n){var s=[];t(e,function(n,i,r){o(n,function(t,e){t?r(t):(e&&s.push({index:i,value:n}),r())})},function(t){t?n(t):n(null,Bt(s.sort(function(t,e){return t.index-e.index}),Ge("value")))})}function Qe(t,e,n,i){(M(e)?We:ze)(t,e,y(n),i||F)}J=Pt(Qe),m=At(Qe),Z=Rt(m,1);function Je(t,e){var n=mt(e||F),i=y(He(t));!function t(e){if(e)return n(e);i(t)}()}it=function(t,e,n,c){c=c||F;var r=y(n);It(t,e,function(n,i){r(n,function(t,e){return t?i(t):i(null,{key:e,val:n})})},function(t,e){for(var n,i,r={},o=Object.prototype.hasOwnProperty,s=0;s<e.length;s++)e[s]&&(n=e[s].key,i=e[s].val,o.call(r,n)?r[n].push(i):r[n]=[i]);return c(t,r)})},_=Rt(it,1/0),st=Rt(it,1),ct=Le("log");function Xe(t,e,n,i){i=q(i||F);var r={},o=y(n);Ot(t,e,function(t,n,i){o(t,n,function(t,e){return t?i(t):(r[n]=e,void i())})},function(t){i(t,r)})}E=Rt(Xe,1/0),Yt=Rt(Xe,1);function Ze(t,n){var o=Object.create(null),s=Object.create(null);n=n||we;var i=y(t),e=a(function(t,e){var r=n.apply(null,t);r in o?h(function(){e.apply(null,o[r])}):r in s?s[r].push(e):(s[r]=[e],i.apply(null,t.concat(function(){var t=v(arguments);o[r]=t;var e=s[r];delete s[r];for(var n=0,i=e.length;n<i;n++)e[n].apply(null,t)})))});return e.memo=o,e.unmemoized=t,e}Jt=s(i?On.nextTick:n?bn:o);function Ke(t,e,n){n=n||F;var r=M(e)?[]:{};t(e,function(t,n,i){y(t)(function(t,e){2<arguments.length&&(e=v(arguments,1)),r[n]=e,i(t)})},function(t){n(t,r)})}function $e(t,e){Ke(St,t,e)}function tn(t,e,n){Ke(Et(e),t,n)}function en(t,e){var n=y(t);return ye(function(t,e){n(t[0],e)},e,1)}ie=function(t,e){var c=en(t,e);return c.push=function(t,e,n){if(null==n&&(n=F),"function"!=typeof n)throw new Error("task callback must be a function");if(c.started=!0,Q(t)||(t=[t]),0===t.length)return h(function(){c.drain()});e=e||0;for(var i=c._tasks.head;i&&e>=i.priority;)i=i.next;for(var r=0,o=t.length;r<o;r++){var s={data:t[r],priority:e,callback:n};i?c._tasks.insertBefore(i,s):c._tasks.push(s)}h(c.process)},delete c.unshift,c};function nn(t,e){if(e=q(e||F),!Q(t))return e(new TypeError("First argument to race must be an array of functions"));if(!t.length)return e();for(var n=0,i=t.length;n<i;n++)y(t[n])(e)}function rn(t,e,n,i){Ee(v(t).reverse(),e,n,i)}function on(t){var e=y(t);return a(function(t,n){return t.push(function(t,e){t?n(null,{error:t}):(e=arguments.length<=2?e:v(arguments,1),n(null,{value:e}))}),e.apply(this,t)})}function sn(t){var n;return Q(t)?n=Bt(t,on):(n={},jt(t,function(t,e){n[e]=on.call(this,t)})),n}function cn(t,e,i,n){Qe(t,e,function(t,n){i(t,function(t,e){n(t,!e)})},n)}ne=Pt(cn),$t=At(cn),Zt=Rt($t,1);function an(t){return function(){return t}}function un(t,e,n){var i={times:5,intervalFunc:an(0)};if(arguments.length<3&&"function"==typeof t?(n=e||F,e=t):(function(t,e){if("object"==typeof e)t.times=+e.times||5,t.intervalFunc="function"==typeof e.interval?e.interval:an(+e.interval||0),t.errorFilter=e.errorFilter;else{if("number"!=typeof e&&"string"!=typeof e)throw new Error("Invalid arguments for async.retry");t.times=+e||5}}(i,t),n=n||F),"function"!=typeof e)throw new Error("Invalid arguments for async.retry");var r=y(e),o=1;!function e(){r(function(t){t&&o++<i.times&&("function"!=typeof i.errorFilter||i.errorFilter(t))?setTimeout(e,i.intervalFunc(o)):n.apply(null,arguments)})}()}te=function(i,t){t||(t=i,i=null);var r=y(t);return a(function(e,t){function n(t){r.apply(null,e.concat(t))}i?un(i,n,t):un(n,t)})};function ln(t,e){Ke(me,t,e)}ee=Pt(Ne(Boolean,we)),Xt=At(Ne(Boolean,we)),Kt=Rt(Xt,1);function pn(t,e,n){var r=y(e);function i(t,e){t=t.criteria,e=e.criteria;return t<e?-1:e<t?1:0}wt(t,function(n,i){r(n,function(t,e){return t?i(t):void i(null,{value:n,criteria:e})})},function(t,e){return t?n(t):void n(null,Bt(e.sort(i),Ge("value")))})}function hn(r,o,s){var c=y(r);return a(function(t,e){var n,i=!1;t.push(function(){i||(e.apply(null,arguments),clearTimeout(n))}),n=setTimeout(function(){var t=r.name||"anonymous";(t=new Error('Callback function "'+t+'" timed out.')).code="ETIMEDOUT",s&&(t.info=s),i=!0,e(t)},o),c.apply(null,t)})}var fn=Math.ceil,dn=Math.max;function _n(t,e,n,i){n=y(n);It(function(t,e,n,i){for(var r=-1,o=dn(fn((e-t)/(n||1)),0),s=Array(o);o--;)s[i?o:++r]=t,t+=n;return s}(0,t,1),e,n,i)}oe=Rt(_n,1/0),re=Rt(_n,1);function vn(t,i,e,n){arguments.length<=3&&(n=e,e=i,i=Q(t)?[]:{}),n=q(n||F);var r=y(e);St(t,function(t,e,n){r(i,t,e,n)},function(t){n(t,i)})}function yn(t,e){var i,r=null;e=e||F,Ve(t,function(t,n){y(t)(function(t,e){i=2<arguments.length?v(arguments,1):e,n(!(r=t))})},function(){e(r,i)})}function gn(t){return function(){return(t.unmemoized||t).apply(null,arguments)}}function mn(e,t,n){n=mt(n||F);var i=y(t);if(!e())return n(null);var r=function(t){if(t)return n(t);if(e())return i(r);t=v(arguments,1);n.apply(null,[null].concat(t))};i(r)}function En(t,e,n){mn(function(){return!t.apply(this,arguments)},e,n)}i=function(n,e){if(e=q(e||F),!Q(n))return e(new Error("First argument to waterfall must be an array of functions"));if(!n.length)return e();var i=0;function r(t){var e=y(n[i++]);t.push(mt(o)),e.apply(null,t)}function o(t){if(t||i===n.length)return e.apply(null,arguments);r(v(arguments,1))}r([])},n={apply:e,applyEach:Nt,applyEachSeries:Ct,asyncify:c,auto:Ut,autoInject:de,cargo:ge,compose:Re,concat:Pe,concatLimit:be,concatSeries:De,constant:Se,detect:Ie,detectLimit:ke,detectSeries:Ce,dir:g,doDuring:xe,doUntil:je,doWhilst:Me,during:Fe,each:Ue,eachLimit:Be,eachOf:St,eachOfLimit:Ot,eachOfSeries:me,eachSeries:Ve,ensureAsync:He,every:O,everyLimit:Y,everySeries:X,filter:J,filterLimit:m,filterSeries:Z,forever:Je,groupBy:_,groupByLimit:it,groupBySeries:st,log:ct,map:wt,mapLimit:It,mapSeries:kt,mapValues:E,mapValuesLimit:Xe,mapValuesSeries:Yt,memoize:Ze,nextTick:Jt,parallel:$e,parallelLimit:tn,priorityQueue:ie,queue:en,race:nn,reduce:Ee,reduceRight:rn,reflect:on,reflectAll:sn,reject:ne,rejectLimit:$t,rejectSeries:Zt,retry:un,retryable:te,seq:Oe,series:ln,setImmediate:h,some:ee,someLimit:Xt,someSeries:Kt,sortBy:pn,timeout:hn,times:oe,timesLimit:_n,timesSeries:re,transform:vn,tryEach:yn,unmemoize:gn,until:En,waterfall:i,whilst:mn,all:O,allLimit:Y,allSeries:X,any:ee,anyLimit:Xt,anySeries:Kt,find:Ie,findLimit:ke,findSeries:Ce,forEach:Ue,forEachSeries:Ve,forEachLimit:Be,forEachOf:St,forEachOfSeries:me,forEachOfLimit:Ot,inject:Ee,foldl:Ee,foldr:rn,select:J,selectLimit:m,selectSeries:Z,wrapSync:c};t.default=n,t.apply=e,t.applyEach=Nt,t.applyEachSeries=Ct,t.asyncify=c,t.auto=Ut,t.autoInject=de,t.cargo=ge,t.compose=Re,t.concat=Pe,t.concatLimit=be,t.concatSeries=De,t.constant=Se,t.detect=Ie,t.detectLimit=ke,t.detectSeries=Ce,t.dir=g,t.doDuring=xe,t.doUntil=je,t.doWhilst=Me,t.during=Fe,t.each=Ue,t.eachLimit=Be,t.eachOf=St,t.eachOfLimit=Ot,t.eachOfSeries=me,t.eachSeries=Ve,t.ensureAsync=He,t.every=O,t.everyLimit=Y,t.everySeries=X,t.filter=J,t.filterLimit=m,t.filterSeries=Z,t.forever=Je,t.groupBy=_,t.groupByLimit=it,t.groupBySeries=st,t.log=ct,t.map=wt,t.mapLimit=It,t.mapSeries=kt,t.mapValues=E,t.mapValuesLimit=Xe,t.mapValuesSeries=Yt,t.memoize=Ze,t.nextTick=Jt,t.parallel=$e,t.parallelLimit=tn,t.priorityQueue=ie,t.queue=en,t.race=nn,t.reduce=Ee,t.reduceRight=rn,t.reflect=on,t.reflectAll=sn,t.reject=ne,t.rejectLimit=$t,t.rejectSeries=Zt,t.retry=un,t.retryable=te,t.seq=Oe,t.series=ln,t.setImmediate=h,t.some=ee,t.someLimit=Xt,t.someSeries=Kt,t.sortBy=pn,t.timeout=hn,t.times=oe,t.timesLimit=_n,t.timesSeries=re,t.transform=vn,t.tryEach=yn,t.unmemoize=gn,t.until=En,t.waterfall=i,t.whilst=mn,t.all=O,t.allLimit=Y,t.allSeries=X,t.any=ee,t.anyLimit=Xt,t.anySeries=Kt,t.find=Ie,t.findLimit=ke,t.findSeries=Ce,t.forEach=Ue,t.forEachSeries=Ve,t.forEachLimit=Be,t.forEachOf=St,t.forEachOfSeries=me,t.forEachOfLimit=Ot,t.inject=Ee,t.foldl=Ee,t.foldr=rn,t.select=J,t.selectLimit=m,t.selectSeries=Z,t.wrapSync=c,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof n&&void 0!==Sn?e(n):"function"==typeof define&&define.amd?define(["exports"],e):e(t.async=t.async||{})}).call(this)}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t("timers").setImmediate)},{_process:7,timers:30}],30:[function(a,t,u){(function(n,c){(function(){var i=a("process/browser.js").nextTick,t=Function.prototype.apply,r=Array.prototype.slice,o={},s=0;function e(t,e){this._id=t,this._clearFn=e}u.setTimeout=function(){return new e(t.call(setTimeout,window,arguments),clearTimeout)},u.setInterval=function(){return new e(t.call(setInterval,window,arguments),clearInterval)},u.clearTimeout=u.clearInterval=function(t){t.close()},e.prototype.unref=e.prototype.ref=function(){},e.prototype.close=function(){this._clearFn.call(window,this._id)},u.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},u.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},u._unrefActive=u.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;0<=e&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},u.setImmediate="function"==typeof n?n:function(t){var e=s++,n=!(arguments.length<2)&&r.call(arguments,1);return o[e]=!0,i(function(){o[e]&&(n?t.apply(null,n):t.call(null),u.clearImmediate(e))}),e},u.clearImmediate="function"==typeof c?c:function(t){delete o[t]}}).call(this)}).call(this,a("timers").setImmediate,a("timers").clearImmediate)},{"process/browser.js":7,timers:30}],31:[function(t,e,n){window.sharedb=t("../../../../node_modules/sharedb/lib/client")},{"../../../../node_modules/sharedb/lib/client":10}]},{},[31]);